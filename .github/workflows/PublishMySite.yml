name: ci

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types: [closed]
    branches: [main, master]
  # âœ… æ–°å¢ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œå¹¶å¸¦ä¸€ä¸ªå¼€å…³
  workflow_dispatch:
    inputs:
      force_ai_summary:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰ AI æ‘˜è¦'
        required: false
        default: false
        type: boolean

# æ ¸å¿ƒæƒé™é…ç½®ï¼šå…è®¸ Action æ¨é€ä»£ç åˆ° gh-pages åˆ†æ”¯
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç  (fetch-depth: 0 ç¡®ä¿èƒ½è·å–æäº¤å†å²ï¼Œç”¨äºç”Ÿæˆæœ€åæ›´æ–°æ—¶é—´)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½® Git ç”¨æˆ· (è¿™å¯¹ mkdocs gh-deploy è‡³å…³é‡è¦)
      - name: Configure Git user
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - uses: actions/setup-python@v4
        with:
          python-version: 3.x

      # 4. è®¾ç½®ç¼“å­˜ ID (å¯é€‰ä¼˜åŒ–)
      - name: Set cache ID
        run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      # 5. æ¢å¤ç¼“å­˜ (å¯é€‰ä¼˜åŒ–)
      - uses: actions/cache@v3
        with:
          key: mkdocs-material-${{ github.run_number }}
          path: .cache
          restore-keys: |
            mkdocs-material-

      # 6. å®‰è£…ä¾èµ– (ç»Ÿä¸€ä½¿ç”¨ requirements.txt)
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt


      # 1. ã€ä¿®æ”¹ã€‘æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶æ›´æ–°çš„æ­¥éª¤
      - name: Check for AI Force Update
        id: check_ai
        run: |
          # è·å–æœ¬æ¬¡ Push åŒ…å«çš„æ‰€æœ‰æäº¤ä¿¡æ¯çš„ JSON å­—ç¬¦ä¸²
          ALL_COMMITS_JSON='${{ toJson(github.event.commits) }}'
          
          # è·å–æ‰‹åŠ¨è§¦å‘çš„çŠ¶æ€
          IS_MANUAL_FORCE="${{ inputs.force_ai_summary }}"
          
          # é€»è¾‘å‡çº§ï¼š
          # 1. å¦‚æœ JSON ä¸­åŒ…å« "[force-ai]" (è¯´æ˜æœ¬æ¬¡æ¨é€çš„å†å²é‡Œæœ‰è¿™ä¸ªæ ‡ç­¾)
          # 2. æˆ–è€… æ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº† true
          if echo "$ALL_COMMITS_JSON" | grep -q "\[force-ai\]" || [[ "$IS_MANUAL_FORCE" == "true" ]]; then
            echo "ğŸš€ æ£€æµ‹åˆ° [force-ai] æ ‡ç­¾æˆ–æ‰‹åŠ¨å¼ºåˆ¶æŒ‡ä»¤ï¼"
            echo "AI_CACHE_MODE=false" >> $GITHUB_ENV
            echo "AI_FORCE_UPDATE=true" >> $GITHUB_ENV
          else
            echo "ğŸ“¦ æœªæ£€æµ‹åˆ°å¼ºåˆ¶æ ‡ç­¾ï¼Œä½¿ç”¨æ ‡å‡†ç¼“å­˜æ¨¡å¼ã€‚"
            echo "AI_CACHE_MODE=false" >> $GITHUB_ENV 
            echo "AI_FORCE_UPDATE=false" >> $GITHUB_ENV
          fi

      # 7. éƒ¨ç½²æ–‡æ¡£
      # æ³¨æ„ï¼šrun å‘½ä»¤å¿…é¡»æ­£ç¡®ç¼©è¿›ï¼Œä¸èƒ½æ··ç”¨ Tab å’Œç©ºæ ¼
      - name: Deploy with AI Summary
        env:
          AI_SUMMARY_FORCE_UPDATE: ${{ env.AI_FORCE_UPDATE }}
          # AIæ‘˜è¦å¼€å…³æ§åˆ¶
          AI_SUMMARY_CI_ENABLED: "true"
          AI_SUMMARY_CI_ONLY_CACHE: ${{ env.AI_CACHE_MODE }}
          AI_SUMMARY_CI_FALLBACK: "true"
          AI_SUMMARY_LOCAL_ENABLED: "true"
          AI_SUMMARY_CACHE_ENABLED: "true"
          # APIå¯†é’¥é…ç½® (ä» Secrets è·å–)
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # --- ä¿®æ”¹ç‚¹ 2: è§£å†³ git-committers 403 æŠ¥é”™ ---
          # æ’ä»¶ä¼šè‡ªåŠ¨è¯»å–è¿™ä¸ªå˜é‡ã€‚GITHUB_TOKEN æ˜¯ Action è‡ªå¸¦çš„ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½® Secret
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: mkdocs gh-deploy --force

      # 8. è‡ªåŠ¨æäº¤æ–°ç”Ÿæˆçš„AIç¼“å­˜æ–‡ä»¶ (å¦‚æœå­˜åœ¨)
      - name: Auto-commit AI cache (if any new files)
        run: |
          if [ -d ".ai_cache" ] && [ "$(ls -A .ai_cache 2>/dev/null)" ]; then
            git add .ai_cache
            # åªæœ‰åœ¨æœ‰å˜åŒ–æ—¶æ‰æäº¤ï¼Œé¿å…æŠ¥é”™
            git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update ai summaries cache [skip ci]" && git push)
          fi