name: ci

on:
  push:
    branches:
      - master
      - main
  pull_request:
    types: [closed]
    branches: [main, master]

# æ ¸å¿ƒæƒé™é…ç½®ï¼šå…è®¸ Action æ¨é€ä»£ç åˆ° gh-pages åˆ†æ”¯
permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç  (fetch-depth: 0 ç¡®ä¿èƒ½è·å–æäº¤å†å²ï¼Œç”¨äºç”Ÿæˆæœ€åæ›´æ–°æ—¶é—´)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½® Git ç”¨æˆ· (è¿™å¯¹ mkdocs gh-deploy è‡³å…³é‡è¦)
      - name: Configure Git user
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - uses: actions/setup-python@v4
        with:
          python-version: 3.x

      # 4. è®¾ç½®ç¼“å­˜ ID (å¯é€‰ä¼˜åŒ–)
      - name: Set cache ID
        run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV

      # 5. æ¢å¤ç¼“å­˜ (å¯é€‰ä¼˜åŒ–)
      - uses: actions/cache@v3
        with:
          key: mkdocs-material-${{ github.run_number }}
          path: .cache
          restore-keys: |
            mkdocs-material-

      # 6. å®‰è£…ä¾èµ– (ç»Ÿä¸€ä½¿ç”¨ requirements.txt)
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt


      # æ–°å¢æ­¥éª¤ï¼šé€šè¿‡ Commit Message åˆ¤æ–­æ˜¯å¦å¼ºåˆ¶åˆ·æ–° AI
      - name: Check for AI Force Update
        id: check_ai
        run: |
          # æ£€æµ‹æäº¤ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å« [force-ai]
          if [[ "${{ github.event.head_commit.message }}" == *"[force-ai]"* ]]; then
            echo "AI_CACHE_MODE=false" >> $GITHUB_ENV
            echo "ğŸš€ Detected [force-ai] tag: Forcing regeneration of summaries."
          else
            echo "AI_CACHE_MODE=true" >> $GITHUB_ENV
            echo "ğŸ“¦ Standard commit: Using cache for existing summaries."
          fi

      # 7. éƒ¨ç½²æ–‡æ¡£
      # æ³¨æ„ï¼šrun å‘½ä»¤å¿…é¡»æ­£ç¡®ç¼©è¿›ï¼Œä¸èƒ½æ··ç”¨ Tab å’Œç©ºæ ¼
      - name: Deploy with AI Summary
        env:
          # AIæ‘˜è¦å¼€å…³æ§åˆ¶
          AI_SUMMARY_CI_ENABLED: "true"
          AI_SUMMARY_CI_ONLY_CACHE: ${{ env.AI_CACHE_MODE }}
          AI_SUMMARY_CI_FALLBACK: "true"
          AI_SUMMARY_LOCAL_ENABLED: "true"
          AI_SUMMARY_CACHE_ENABLED: "true"
          # APIå¯†é’¥é…ç½® (ä» Secrets è·å–)
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # --- ä¿®æ”¹ç‚¹ 2: è§£å†³ git-committers 403 æŠ¥é”™ ---
          # æ’ä»¶ä¼šè‡ªåŠ¨è¯»å–è¿™ä¸ªå˜é‡ã€‚GITHUB_TOKEN æ˜¯ Action è‡ªå¸¦çš„ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½® Secret
          MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.GITHUB_TOKEN }}
        run: mkdocs gh-deploy --force

      # 8. è‡ªåŠ¨æäº¤æ–°ç”Ÿæˆçš„AIç¼“å­˜æ–‡ä»¶ (å¦‚æœå­˜åœ¨)
      - name: Auto-commit AI cache (if any new files)
        run: |
          if [ -d ".ai_cache" ] && [ "$(ls -A .ai_cache 2>/dev/null)" ]; then
            git add .ai_cache
            # åªæœ‰åœ¨æœ‰å˜åŒ–æ—¶æ‰æäº¤ï¼Œé¿å…æŠ¥é”™
            git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update ai summaries cache [skip ci]" && git push)
          fi