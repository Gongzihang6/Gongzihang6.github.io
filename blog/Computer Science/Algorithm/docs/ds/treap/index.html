
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录、分享">
      
      
        <meta name="author" content="Dev-XYS, ttzytt, Sora233, qwqAutomaton">
      
      
        <link rel="canonical" href="https://gongzihang6.github.io/blog/Computer%20Science/Algorithm/docs/ds/treap/">
      
      
      
      
      <link rel="icon" href="https://s2.loli.net/2025/02/12/aE5ovtzAlNTd9Uh.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Treap - Blog of GZH</title>
      
    
    
      <link rel="stylesheet" href="../../../../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../../../../stylesheets/extra2.css">
    
      <link rel="stylesheet" href="../../../../../../stylesheets/简历.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Wcowin/Wcowin.github.io@main/docs/stylesheets/link.css">
    
      <link rel="stylesheet" href="../../../../../../stylesheets/customize.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600&display=swap">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Wcowin/Wcowin.github.io@main/docs/stylesheets/ziti.css">
    
    <script>__md_scope=new URL("../../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-40HC6RYSR1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-40HC6RYSR1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-40HC6RYSR1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../../.." title="Blog of GZH" class="md-header__button md-logo" aria-label="Blog of GZH" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Blog of GZH
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Treap
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="关闭自动模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="关闭自动模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="切换至日间模式"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 128c0-35.3 28.7-64 64-64h512c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64zm320 0v256h256V128zm-141.7 47.9c-3.2-7.2-10.4-11.9-18.3-11.9s-15.1 4.7-18.3 11.9l-64 144c-4.5 10.1.1 21.9 10.2 26.4s21.9-.1 26.4-10.2l8.9-20.1h73.6l8.9 20.1c4.5 10.1 16.3 14.6 26.4 10.2s14.6-16.3 10.2-26.4zM160 233.2l19 42.8h-38zM448 164c11 0 20 9 20 20v4h60c11 0 20 9 20 20s-9 20-20 20h-2l-1.6 4.5c-8.9 24.4-22.4 46.6-39.6 65.4.9.6 1.8 1.1 2.7 1.6l18.9 11.3c9.5 5.7 12.5 18 6.9 27.4s-18 12.5-27.4 6.9L467 333.8c-4.5-2.7-8.8-5.5-13.1-8.5-10.6 7.5-21.9 14-34 19.4l-3.6 1.6c-10.1 4.5-21.9-.1-26.4-10.2s.1-21.9 10.2-26.4l3.6-1.6c6.4-2.9 12.6-6.1 18.5-9.8L410 286.1c-7.8-7.8-7.8-20.5 0-28.3s20.5-7.8 28.3 0l14.6 14.6.5.5c12.4-13.1 22.5-28.3 29.8-45l-35.2.1h-72c-11 0-20-9-20-20s9-20 20-20h52v-4c0-11 9-20 20-20"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/Mkdocs-Wcowin/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/Mkdocs-Wcowin/ZH-TW/" hreflang="zh-TW" class="md-select__link">
              China(TW)
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256l137.3-137.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Gongzihang6" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Gongzihang6
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../.." class="md-tabs__link">
        
  
  
    
  
  主页

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../java%E5%9F%BA%E7%A1%80/" class="md-tabs__link">
          
  
  
    
  
  Computer Science

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../MachineLearning/K%E8%BF%91%E9%82%BB%E5%AD%A6%E4%B9%A0%E4%B8%8E%E9%99%8D%E7%BB%B4/" class="md-tabs__link">
          
  
  
    
  
  MachineLearning

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E8%99%9E%E7%BE%8E%E4%BA%BA%C2%B7%E7%8E%89%E9%98%91%E5%B9%B2%E5%A4%96%E6%B8%85%E6%B1%9F%E6%B5%A6/" class="md-tabs__link">
          
  
  
    
  
  每日诗词

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../%E9%95%BF%E6%9C%9F%E4%B8%BB%E4%B9%89/fitness/" class="md-tabs__link">
          
  
  
    
  
  长期主义

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../../about/geren/" class="md-tabs__link">
          
  
  
    
  
  关于

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../../.." title="Blog of GZH" class="md-nav__button md-logo" aria-label="Blog of GZH" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    Blog of GZH
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Gongzihang6" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Gongzihang6
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    主页
    
  </span>
  
    
  
  
    <span class="md-status md-status--new"></span>
  

  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Computer Science
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Computer Science
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../java%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java面向对象基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../%E5%B8%B8%E7%94%A8API/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java集合框架与常用API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../java%E6%8F%90%E9%AB%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java高级技术
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Algorithm
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Algorithm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/%E5%B9%B6%E6%9F%A5%E9%9B%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    并查集
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LeetCode热题100
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            LeetCode热题100
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode%E7%83%AD%E9%A2%98100/%E5%AD%97%E6%AF%8D%E5%BC%82%E4%BD%8D%E8%AF%8D%E5%88%86%E7%BB%84/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    字母异位词分组
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    LeetCode
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            LeetCode
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E4%BA%A4%E6%98%93%E9%80%86%E5%BA%8F%E5%AF%B9%E7%9A%84%E6%80%BB%E6%95%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    交易逆序对的总数
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%8D%95%E8%AF%8D%E6%8E%A5%E9%BE%99/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    单词接龙
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%B2%9B%E5%B1%BF%E6%95%B0%E9%87%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    岛屿数量
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%88%86%E8%80%83%E5%9C%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分考场
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E6%8B%89%E9%A9%AC%E8%BD%A6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    拉马车
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%88%86%E5%B7%A7%E5%85%8B%E5%8A%9B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    分巧克力
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/k%E5%80%8D%E5%8C%BA%E9%97%B4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    K倍区间
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    编辑距离
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E6%8E%A5%E9%9B%A8%E6%B0%B4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    接雨水
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E7%BB%84%E5%90%88%E6%80%BB%E5%92%8C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    组合总和
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%85%A8%E6%8E%92%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    全排列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E4%B9%98%E7%A7%AF%E6%9C%80%E5%A4%A7%E5%AD%90%E6%95%B0%E7%BB%84/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    乘积最大子数组
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5. 最长回文子串
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%89%8DK%E4%B8%AA%E9%AB%98%E9%A2%91%E5%85%83%E7%B4%A0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    前K个高频元素
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E6%9C%80%E5%B0%8F%E6%A0%88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    最小栈
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/Pow%28x%2Cn%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pow(x,n)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E7%BD%91%E7%BB%9C%E5%BB%B6%E8%BF%9F%E6%97%B6%E9%97%B4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    网络延迟时间
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E8%AE%A1%E7%AE%97%E8%B4%A8%E6%95%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    计算质数
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E5%AF%B9%E8%A7%92%E7%BA%BF%E4%B8%8A%E7%9A%84%E8%B4%A8%E6%95%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    对角线上的质数
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E9%9B%B6%E9%92%B1%E5%85%91%E6%8D%A2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    零钱兑换
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/01%E7%9F%A9%E9%98%B5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    01矩阵
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    二分查找
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/%E6%8B%AC%E5%8F%B7%E5%8C%B9%E9%85%8D/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    括号匹配
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/300%E6%9C%80%E9%95%BF%E9%80%92%E5%A2%9E%E5%AD%90%E5%BA%8F%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    300最长递增子序列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/115%E4%B8%8D%E5%90%8C%E7%9A%84%E5%AD%90%E5%BA%8F%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    115不同的子序列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/712%E4%B8%A4%E4%B8%AA%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%9C%80%E5%B0%8FASCII%E5%88%A0%E9%99%A4%E5%92%8C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    712两个字符串的最小ASCII删除和
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/516%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E5%BA%8F%E5%88%97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    516最长回文子序列
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/139%E5%8D%95%E8%AF%8D%E6%8B%86%E5%88%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    139单词拆分
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/221%E6%9C%80%E5%A4%A7%E6%AD%A3%E6%96%B9%E5%BD%A2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    221最大正方形
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2845%E7%BB%9F%E8%AE%A1%E8%B6%A3%E5%91%B3%E5%AD%90%E6%95%B0%E7%BB%84%E7%9A%84%E6%95%B0%E7%9B%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2845统计趣味子数组的数目
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2799%E7%BB%9F%E8%AE%A1%E5%AE%8C%E5%85%A8%E5%AD%90%E6%95%B0%E7%BB%84%E7%9A%84%E6%95%B0%E7%9B%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2799统计完全子数组的数目
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/1399%E7%BB%9F%E8%AE%A1%E6%9C%80%E5%A4%A7%E7%BB%84%E7%9A%84%E6%95%B0%E7%9B%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1399统计最大组的数目
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2338%E7%BB%9F%E8%AE%A1%E7%90%86%E6%83%B3%E6%95%B0%E7%BB%84%E7%9A%84%E6%95%B0%E7%9B%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2338统计理想数组的数目
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2179%E7%BB%9F%E8%AE%A1%E6%95%B0%E7%BB%84%E4%B8%AD%E5%A5%BD%E4%B8%89%E5%85%83%E7%BB%84%E6%95%B0%E7%9B%AE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2179统计数组中好三元组数目
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2537%E7%BB%9F%E8%AE%A1%E5%A5%BD%E5%AD%90%E6%95%B0%E7%BB%84%E7%9A%84%E6%95%B0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2537统计好子数组的数
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2140%E8%A7%A3%E5%86%B3%E6%99%BA%E5%8A%9B%E9%97%AE%E9%A2%98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2140解决智力问题
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../LeetCode/2278%E5%AD%97%E6%AF%8D%E5%9C%A8%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E7%9A%84%E7%99%BE%E5%88%86%E6%AF%94/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2278字母在字符串中的百分比
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    MachineLearning
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            MachineLearning
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../MachineLearning/K%E8%BF%91%E9%82%BB%E5%AD%A6%E4%B9%A0%E4%B8%8E%E9%99%8D%E7%BB%B4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    K近邻学习与降维
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../MachineLearning/%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%B8%8E%E5%A4%9A%E5%88%86%E7%B1%BB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    模型评估与多分类
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../MachineLearning/%E5%85%AC%E5%BC%8F%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    公式测试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../MachineLearning/%E7%BB%8F%E5%85%B8%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    经典卷积神经网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../MachineLearning/%E7%90%86%E8%A7%A3YOLO%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    理解YOLO网络结构
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    每日诗词
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            每日诗词
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E8%99%9E%E7%BE%8E%E4%BA%BA%C2%B7%E7%8E%89%E9%98%91%E5%B9%B2%E5%A4%96%E6%B8%85%E6%B1%9F%E6%B5%A6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    虞美人·玉阑干外清江浦
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E8%8F%A9%E8%90%A8%E8%9B%AE%C2%B7%E5%9B%9E%E6%96%87%E5%A4%8F%E9%97%BA%E6%80%A8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    菩萨蛮·回文夏闺怨
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E6%B8%85%E5%B9%B3%E4%B9%90%C2%B7%E5%85%AD%E7%9B%98%E5%B1%B1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    清平乐·六盘山
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E6%B4%9E%E4%BB%99%E6%AD%8C%C2%B7%E5%92%8F%E6%9F%B3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    洞仙歌·咏柳
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E7%A7%8B%E5%85%B4%E5%85%AB%E9%A6%96%C2%B7%E5%85%B6%E4%B8%80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    秋兴八首·其一
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E4%B8%8E%E5%8F%B2%E9%83%8E%E4%B8%AD%E9%92%A6%E5%90%AC%E9%BB%84%E9%B9%A4%E6%A5%BC%E4%B8%8A%E5%90%B9%E7%AC%9B/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    与史郎中钦听黄鹤楼上吹笛
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E5%A4%8F%E6%97%A5%E5%8D%97%E4%BA%AD%E6%80%80%E8%BE%9B%E5%A4%A7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    夏日南亭怀辛大
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E8%A1%8C%E9%A6%99%E5%AD%90%C2%B7%E7%A7%8B%E4%B8%8E/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    行香子·秋与
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E6%AF%8F%E6%97%A5%E8%AF%97%E8%AF%8D/%E8%87%AA%E9%A2%98%E9%87%91%E5%B1%B1%E7%94%BB%E5%83%8F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自题金山画像
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    长期主义
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            长期主义
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../%E9%95%BF%E6%9C%9F%E4%B8%BB%E4%B9%89/fitness/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fitness
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    关于
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            关于
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../about/geren/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    作者个人简介
    
  </span>
  
    
  
  
    <span class="md-status md-status--new"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../about/%E7%AE%80%E5%8E%86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    个人简历
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../about/zcw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    支持作者
    
  </span>
  
    
  
  
    <span class="md-status md-status--new"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../../about/test/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    功能测试
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      简介
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#treap" class="md-nav__link">
    <span class="md-ellipsis">
      Treap 复杂度的证明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Treap 复杂度的证明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      记号约定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      树高的证明
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#treap_1" class="md-nav__link">
    <span class="md-ellipsis">
      旋转 treap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="旋转 treap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      节点结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      旋转
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      插入
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      删除
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      根据值查询排名
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      根据排名查询值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#val" class="md-nav__link">
    <span class="md-ellipsis">
      查询第一个比 val 小的节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#val_1" class="md-nav__link">
    <span class="md-ellipsis">
      查询第一个比 val 大的节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#treap_2" class="md-nav__link">
    <span class="md-ellipsis">
      无旋 treap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无旋 treap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#split" class="md-nav__link">
    <span class="md-ellipsis">
      分裂（split）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="分裂（split）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      按值分裂
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      按排名分裂
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#merge" class="md-nav__link">
    <span class="md-ellipsis">
      合并（merge）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      插入
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      删除
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      根据值查询排名
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      根据排名查询值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#val_2" class="md-nav__link">
    <span class="md-ellipsis">
      查询第一个比 val 小的节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#val_3" class="md-nav__link">
    <span class="md-ellipsis">
      查询第一个比 val 大的节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    <span class="md-ellipsis">
      建树（build）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#treap_3" class="md-nav__link">
    <span class="md-ellipsis">
      无旋 treap 的区间操作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无旋 treap 的区间操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      建树
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      区间翻转
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      下传标记
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      分裂
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      合并
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      区间翻转
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      中序遍历打印
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      完整代码
    </span>
  </a>
  
    <nav class="md-nav" aria-label="完整代码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#treap_4" class="md-nav__link">
    <span class="md-ellipsis">
      旋转 treap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="旋转 treap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      指针实现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      数组实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#treap_5" class="md-nav__link">
    <span class="md-ellipsis">
      无旋 treap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无旋 treap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      指针实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#treap_6" class="md-nav__link">
    <span class="md-ellipsis">
      无旋 treap 的区间操作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="无旋 treap 的区间操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      指针实现
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      例题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      参考资料与注释
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Treap</h1>

<div class="admonition info">
<p class="admonition-title">💾 AI智能摘要 (DeepSeek)</p>
<p>Treap是一种结合二叉搜索树和堆特性的弱平衡数据结构，通过随机优先级避免朴素二叉搜索树退化成链的问题。其节点同时维护权值（满足二叉搜索树性质）和随机优先级（满足堆性质），使树结构在期望下保持平衡，操作复杂度稳定在O(log n)。数学证明表明，随机优先级能确保节点深度期望为对数级别，从而提升查询效率。适用于需要高效动态维护有序数据的场景。</p>
</div>
<div class="admonition info">
<p class="admonition-title">📖 阅读信息</p>
<p>阅读时间：<strong>7</strong> 分钟 | 中文字符：<strong>2671</strong> | 有效代码行数：<strong>831</strong></p>
</div>
<p>前置知识：<a href="../bst/">朴素二叉搜索树</a>，<a href="../heap/">堆基础</a>。</p>
<h2 id="_1">简介<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Treap（树堆）是一种 <strong>弱平衡</strong> 的 <strong>二叉搜索树</strong>。</p>
<p>Treap 的结点除了被维护的 <strong>权值</strong>（<span class="arithmatex">\(\textit{val}\)</span>）之外，还附加了一个随机的 <strong>优先级</strong>（<span class="arithmatex">\(\textit{priority}\)</span>）。其中，权值满足二叉搜索树性质，优先级满足堆性质（小根堆或大根堆）。</p>
<p>其中，二叉搜索树的性质是指：</p>
<ul>
<li>左子节点的权值（<span class="arithmatex">\(\textit{val}\)</span>）比父节点小。</li>
<li>右子节点的权值（<span class="arithmatex">\(\textit{val}\)</span>）比父节点大。</li>
</ul>
<p>堆的性质是：</p>
<ul>
<li>子节点优先级（<span class="arithmatex">\(\textit{priority}\)</span>）比父节点大或小（取决于是小根堆还是大根堆）。</li>
</ul>
<p>不难看出，如果用的是同一个值，那么这两种数据结构在组合后会变成一条链，所以我们再在搜索树的基础上，引入一个给堆的值 <span class="arithmatex">\(\textit{priority}\)</span>。对于 <span class="arithmatex">\(\textit{val}\)</span> 值，我们维护搜索树的性质，对于 <span class="arithmatex">\(\textit{priority}\)</span> 值，我们维护堆的性质。其中 <span class="arithmatex">\(\textit{priority}\)</span> 这个值是随机给出的。</p>
<p>下图就是一个 Treap 的例子（这里使用的是小根堆，即根节点的优先级最小）。</p>
<p><img alt="一个 Treap 的例子" src="../images/treap-treap-example.svg" /></p>
<p>那我们为什么需要大费周章的去让这个数据结构符合树和堆的性质，并且随机给出堆的值呢？</p>
<p>要理解这个，首先需要理解朴素二叉搜索树的问题。在给朴素搜索树插入一个新节点时，我们需要从这个搜索树的根节点开始递归，如果新节点比当前节点小，那就向左递归，反之亦然。</p>
<p>最后当发现当前节点没有子节点时，就根据新节点的值的大小，让新节点成为当前节点的左或右子节点。</p>
<p>如果插入结点的权值是随机的（换言之，是随机插入的），那这个朴素搜索树的高度较小（接近 <span class="arithmatex">\(\log n\)</span>，其中 <span class="arithmatex">\(n\)</span> 为结点数），而每一层的节点数较多，即它的形状会非常的「胖」。上图的 Treap 就是一个例子。因此此时的任意操作复杂度都将会是 <span class="arithmatex">\(O(\log n)\)</span> 左右。</p>
<p>不过，这只是在随机情况下的复杂度，如果我们按照下面这个非常有序的顺序给一个朴素的搜索树插入节点：</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>1 2 3 4 5
</code></pre></div></td></tr></table></div>
<p>那么这棵树将会退化成链，即变得非常「瘦长」（每次插入的节点都比前面的大，所以都被安排到右子节点了）：</p>
<p><img alt="退化成链的例子" src="../images/treap-search-tree-chain.svg" /></p>
<p>不难看出，查询的复杂度也从 <span class="arithmatex">\(O(\log n)\)</span> 变成了 <span class="arithmatex">\(O(n)\)</span>.</p>
<p>而 treap 为了解决这个问题、达到一个较为「平衡」的状态，通过维护随机的优先级满足堆性质，「打乱」了节点的插入顺序，从而让二叉搜索树达到了理想的复杂度，避免了退化成链的问题。</p>
<h2 id="treap">Treap 复杂度的证明<a class="headerlink" href="#treap" title="Permanent link">&para;</a></h2>
<p>由于 treap 各种操作的复杂度都和所操作的结点的深度有关，我们首先证明，所有结点的期望高度都是 <span class="arithmatex">\(O(\log n)\)</span>.</p>
<h3 id="_2">记号约定<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>为了方便表述，我们约定：</p>
<ul>
<li><span class="arithmatex">\(n\)</span> 是节点个数。</li>
<li>Treap 结点中满足二叉搜索树性质的称为 <strong>权值</strong>，满足堆性质的（也就是随机的）称为 <strong>优先级</strong>。不妨设优先级满足小根堆性质。</li>
<li><span class="arithmatex">\(x_k\)</span> 表示权值第 <span class="arithmatex">\(k\)</span> 小的结点。</li>
<li><span class="arithmatex">\(X_{i,j}\)</span> 表示集合 <span class="arithmatex">\(\{x_i,x_{i+1},\cdots,x_{j-1},x_j\}\)</span>，即按权值升序排列后第 <span class="arithmatex">\(i\)</span> 个到第 <span class="arithmatex">\(j\)</span> 个的结点构成的集合。</li>
<li><span class="arithmatex">\(\operatorname{dep}(x)\)</span> 表示结点 <span class="arithmatex">\(x\)</span> 的深度。规定根节点的深度是 <span class="arithmatex">\(0\)</span>.</li>
<li><span class="arithmatex">\(Y_{i,j}\)</span> 是一个指示器随机变量，当 <span class="arithmatex">\(x_i\)</span> 是 <span class="arithmatex">\(x_j\)</span> 的祖先时值为 <span class="arithmatex">\(1\)</span>，否则为 <span class="arithmatex">\(0\)</span>. 特别地，<span class="arithmatex">\(Y_{i,i}=0\)</span>.</li>
<li><span class="arithmatex">\(\Pr(A)\)</span> 表示事件 <span class="arithmatex">\(A\)</span> 发生的概率。</li>
</ul>
<h3 id="_3">树高的证明<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>由于结点 <span class="arithmatex">\(x_i\)</span> 的深度等于它祖先的个数，因此有</p>
<div class="arithmatex">\[
\operatorname{dep}(x_i)=\sum_{k=1}^nY_{k,i}
\]</div>
<p>那么根据期望的线性性，有</p>
<div class="arithmatex">\[
E(\operatorname{dep}(x_i))=E\left(\sum_{k=1}^nY_{k,i}\right)=\sum_{k=1}^nE(Y_{k,i})
\]</div>
<p>由于 <span class="arithmatex">\(Y_{k,i}\)</span> 是指示器随机变量，它的期望就等于它为 <span class="arithmatex">\(1\)</span> 的概率，因此</p>
<div class="arithmatex">\[
E(\operatorname{dep}(x_i))=\sum_{k=1}^n\Pr(Y_{k,i}=1)
\]</div>
<p>我们先证明引理：<span class="arithmatex">\(Y_{i,j}=1\)</span> 当且仅当 <span class="arithmatex">\(x_i\)</span> 的优先级是 <span class="arithmatex">\(X_{i,j}\)</span> 中最小的。</p>
<details class="note">
<summary>引理的证明</summary>
<p><strong>证明</strong>：考虑分类讨论 <span class="arithmatex">\(x_i\)</span> 和 <span class="arithmatex">\(x_j\)</span> 的情况。</p>
<ol>
<li>若 <span class="arithmatex">\(x_i\)</span> 是根节点：由于优先级满足小根堆性质，<span class="arithmatex">\(x_i\)</span> 的优先级最小，并且对于任意的 <span class="arithmatex">\(x_j\)</span>，<span class="arithmatex">\(x_i\)</span> 都是 <span class="arithmatex">\(x_j\)</span> 的祖先。</li>
<li>若 <span class="arithmatex">\(x_j\)</span> 是根节点：同理，<span class="arithmatex">\(x_j\)</span> 优先级最小，因此 <span class="arithmatex">\(x_i\)</span> 不是 <span class="arithmatex">\(X_{i,j}\)</span> 中优先级最小的；同时 <span class="arithmatex">\(x_i\)</span> 也不是 <span class="arithmatex">\(x_j\)</span> 的祖先。</li>
<li>若 <span class="arithmatex">\(x_i\)</span> 和 <span class="arithmatex">\(x_j\)</span> 在根节点的两个子树中（一左一右），那么根节点 <span class="arithmatex">\(r\in X_{i,j}\)</span>. 因此 <span class="arithmatex">\(x_i\)</span> 的优先级不可能是 <span class="arithmatex">\(X_{i,j}\)</span> 中最小的（因为根节点的比它小）。同时，由于 <span class="arithmatex">\(x_i\)</span> 和 <span class="arithmatex">\(x_j\)</span> 分属两个子树，<span class="arithmatex">\(x_i\)</span> 也不是 <span class="arithmatex">\(x_j\)</span> 的祖先。</li>
<li>若 <span class="arithmatex">\(x_i\)</span> 和 <span class="arithmatex">\(x_j\)</span> 在根节点的同一个子树中，此时可以将这个子树单独拿出来作为一棵新的 treap，递归进行上面的证明即可。<span class="arithmatex">\(\square\)</span></li>
</ol>
</details>
<p>那么根据引理，深度的期望可以转化成</p>
<div class="arithmatex">\[
E(\operatorname{dep}(x_i))=\sum_{k=1}^n\Pr(x_k=\min X_{i,k}\land k\neq i)
\]</div>
<p>又因为结点的优先级是随机的，我们假定集合 <span class="arithmatex">\(X_{i,j}\)</span> 中任何一个结点的优先级最小的概率都相同，那么</p>
<div class="arithmatex">\[
\begin{aligned}
E(\operatorname{dep}(x_i))&amp;=\sum_{k=1}^n\Pr(x_k=\min X_{i,k}\land k\neq i)\\
&amp;=\sum_{k=1}^{n}\Pr(x_k=\min X_{i,k})-1\\
&amp;=\sum_{k=1}^n\dfrac{1}{|i-k|+1}-1\\
&amp;=\sum_{k=1}^{i-1}\dfrac{1}{i-k+1}+\sum_{k=i+1}^n\dfrac{1}{k-i+1}\\
&amp;=\sum_{j=2}^i\dfrac 1j+\sum_{j=2}^{n-i+1}\dfrac 1j\\
&amp;\le 2\sum_{j=2}^n\dfrac 1j &lt; 2\sum_{j=2}^n\int_{j-1}^j\dfrac 1x\mathrm dx\\
&amp;=2\int_1^n\dfrac 1x\mathrm dx=2\ln n=O(\log n)
\end{aligned}
\]</div>
<p>因此每个结点的期望高度都是 <span class="arithmatex">\(O(\log n)\)</span>.</p>
<p>而朴素的二叉搜索树的操作的复杂度均是 <span class="arithmatex">\(O(h)\)</span>，同时 treap 维护堆性质的复杂度也是 <span class="arithmatex">\(O(h)\)</span> 的，因此 treap 各种操作的期望复杂度都是 <span class="arithmatex">\(O(\log n)\)</span>.</p>
<details class="note" open="open">
<summary>期望复杂度的感性理解</summary>
<p>首先，我们需要认识到一个节点的 <span class="arithmatex">\(\textit{priority}\)</span> 属性是和它所在的层数有直接关联的。再回忆堆的性质：</p>
<ul>
<li>子节点值（<span class="arithmatex">\(\textit{priority}\)</span>）比父节点大或小（取决于是小根堆还是大根堆）</li>
</ul>
<p>我们发现层数低的节点，比如整个树的根节点，它的 <span class="arithmatex">\(\textit{priority}\)</span> 属性也会更小（在小根堆中）。并且，在朴素的搜索树中，先被插入的节点，也更有可能会有比较小的层数。我们可以把这个 <span class="arithmatex">\(\textit{priority}\)</span> 属性和被插入的顺序关联起来理解，这样，也就理解了为什么 treap 可以把节点插入的顺序通过 <span class="arithmatex">\(\textit{priority}\)</span> 打乱。</p>
</details>
<p>给 treap 插入新节点时，需要同时维护树和堆的性质。其中，搜索树的性质可以在插入时维护，而堆性质的维护则有两种处理方法，分别是旋转和分裂、合并。使用这两种方法的 treap 被分别称为 <strong>旋转 treap</strong> 和 <strong>无旋 treap</strong>。</p>
<h2 id="treap_1">旋转 treap<a class="headerlink" href="#treap_1" title="Permanent link">&para;</a></h2>
<p><strong>旋转 treap</strong> 维护平衡的方式为旋转，和 AVL 树的旋转操作类似，分为 <strong>左旋</strong> 和 <strong>右旋</strong>。即在满足二叉搜索树的条件下根据堆的优先级对 treap 进行平衡操作。</p>
<p>旋转 treap 在做普通平衡树题的时候，是所有平衡树中常数较小的。</p>
<p>下面的讲解中的代码用指针实现了旋转 treap，文末附有数组形式的完整实现。</p>
<details class="info" open="open">
<summary>Info</summary>
<p>代码中的 <code>rank</code> 代表前面讲的优先级（<span class="arithmatex">\(\textit{priority}\)</span> 属性），该属性满足的是小根堆性质。</p>
</details>
<h3 id="_4">节点结构<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">  </span><span class="c1">// 两个子节点的地址</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">rep_cnt</span><span class="p">;</span><span class="w">  </span><span class="c1">// 当前这个值（val）重复出现的次数</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">siz</span><span class="p">;</span><span class="w">      </span><span class="c1">// 以当前节点为根的子树大小</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="n">Node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">val</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="w"> </span><span class="n">rep_cnt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">    </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="c1">// 注意初始化的时候，rank 是随机给出的</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">upd_siz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="c1">// 用于旋转和删除过后，重新计算 siz 的值</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="n">siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rep_cnt</span><span class="p">;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="p">};</span>
</code></pre></div></td></tr></table></div>
<h3 id="_5">旋转<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>旋转操作是 treap 的一个非常重要的操作，主要用来在保持 treap 树性质的同时，调整不同节点的层数，以达到维护堆性质的作用。</p>
<p>旋转操作的左旋和右旋可能不是特别容易区分，以下是两个较为明显的特点：</p>
<p>旋转操作的含义：</p>
<ul>
<li>在不影响搜索树性质的前提下，把和旋转方向相反的子树变成根节点（如左旋，就是把右子树变成根节点）</li>
<li>不影响性质，并且在旋转过后，跟旋转方向相同的子节点变成了原来的根节点（如左旋，旋转完之后的左子节点是旋转前的根节点）</li>
</ul>
<p>左旋和右旋操作是相互的，如下图。</p>
<p><img alt="旋转操作" src="../images/treap-rotate.svg" /></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">enum</span><span class="w"> </span><span class="nc">rot_type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">LF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_rotate</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">cur</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">             </span><span class="n">rot_type</span><span class="w"> </span><span class="n">dir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// dir参数代表旋转的方向 0为右旋，1为左旋</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="c1">// 注意传进来的 cur 是指针的引用，也就是改了这个</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="c1">// cur，变量是跟着一起改的，如果这个 cur 是别的 树的子节点，根据 ch</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="c1">// 找过来的时候，也是会找到这里的</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="c1">// 以下的代码解释的均是左旋时的情况</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">dir</span><span class="p">];</span><span class="w">  </span><span class="c1">// 让 C 变成根节点，</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">                             </span><span class="c1">// 这里的 tmp</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">                             </span><span class="c1">// 是一个临时的节点指针，指向成为新的根节点的节点</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="cm">/* 左旋：也就是让右子节点变成根节点</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="cm">   *         A                 C</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="cm">   *        / \               / \</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="cm">   *       B  C    ----&gt;     A   E</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="cm">   *         / \            / \</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="cm">   *        D   E          B   D</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="cm">   */</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">  </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">];</span><span class="w">    </span><span class="c1">// 让 A 的右子节点变成 D</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">  </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span><span class="w">             </span><span class="c1">// 让 C 的左子节点变成 A</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">  </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">(),</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span><span class="w">  </span><span class="c1">// 更新大小信息</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">  </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w">  </span><span class="c1">// 最后把临时储存 C 树的变量赋值到当前根节点上（注意 cur 是引用）</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_6">插入<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>类似普通二叉搜索树的插入，但是需要在插入的过程中通过旋转来维护优先级的堆性质。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span>
<span class="normal"><a href="#__codelineno-3-16">16</a></span>
<span class="normal"><a href="#__codelineno-3-17">17</a></span>
<span class="normal"><a href="#__codelineno-3-18">18</a></span>
<span class="normal"><a href="#__codelineno-3-19">19</a></span>
<span class="normal"><a href="#__codelineno-3-20">20</a></span>
<span class="normal"><a href="#__codelineno-3-21">21</a></span>
<span class="normal"><a href="#__codelineno-3-22">22</a></span>
<span class="normal"><a href="#__codelineno-3-23">23</a></span>
<span class="normal"><a href="#__codelineno-3-24">24</a></span>
<span class="normal"><a href="#__codelineno-3-25">25</a></span>
<span class="normal"><a href="#__codelineno-3-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_insert</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="c1">// 没这个节点直接新建</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="c1">// 如果有这个值相同的节点，就把重复数量加一</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">siz</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="c1">// 维护搜索树性质，val 比当前节点小就插到左边，反之亦然</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="n">_insert</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">      </span><span class="c1">// 小根堆中，上面节点的优先级一定更小</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">      </span><span class="c1">// 因为新插的左子节点比父节点小，现在需要让左子节点变成父节点</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">      </span><span class="n">_rotate</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">RT</span><span class="p">);</span><span class="w">  </span><span class="c1">// 注意前面的旋转性质，要把左子节点转上来，需要右旋</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span><span class="w">  </span><span class="c1">// 插入之后大小会变化，需要更新</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="n">_insert</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">      </span><span class="n">_rotate</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">LF</span><span class="p">);</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_7">删除<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>主要就是分类讨论，不同的情况有不同的处理方法，删完了树的大小会有变化，要注意更新。并且如果要删的节点有左子树和右子树，就要考虑删除之后让谁来当父节点（维护 rank 小的节点在上面）。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">_del</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">_del</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="c1">// 值更大就在右子树，反之亦然</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="n">_del</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">      </span><span class="c1">// 如果要删除的节点是重复的，可以直接把重复值减小</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="o">--</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">siz</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="c1">// 00都无，01有左无右，10，无左有右，11都有</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">        </span><span class="c1">// 没有任何子节点，就直接把这个节点删了</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">  </span><span class="c1">// 有左无右</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">        </span><span class="c1">// 把根变成左儿子，然后把原来的根节删了，注意这里的 tmp 是从 cur</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">        </span><span class="c1">// 复制的，而 cur 是引用</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w">  </span><span class="c1">// 有右无左</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">        </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">        </span><span class="n">rot_type</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">                           </span><span class="o">?</span><span class="w"> </span><span class="n">RT</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">                           </span><span class="o">:</span><span class="w"> </span><span class="n">LF</span><span class="p">;</span><span class="w">  </span><span class="c1">// dir 是 rank 更小的那个儿子</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">        </span><span class="n">_rotate</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">);</span><span class="w">  </span><span class="c1">// 这里的旋转可以把优先级更小的儿子转上去，rt 是 0，</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">                            </span><span class="c1">// 而 lf 是 1，刚好跟实际的子树下标反过来</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">        </span><span class="n">_del</span><span class="p">(</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">            </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">],</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">            </span><span class="n">val</span><span class="p">);</span><span class="w">  </span><span class="c1">// 旋转完成后原来的根节点就在旋方向那边，所以需要</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">                   </span><span class="c1">// 继续把这个原来的根节点删掉</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="w">                   </span><span class="c1">// 如果说要删的这个节点是在整个树的「上层的」，那我们会一直通过这</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">                   </span><span class="c1">// 这里的旋转操作，把它转到没有子树了（或者只有一个），再删掉它。</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="w">        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="w">        </span><span class="c1">// 删除会造成大小改变</span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_8">根据值查询排名<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>操作含义：查询以 cur 为根节点的子树中，val 这个值的大小的排名（该子树中小于 val 的节点的个数 + 1）</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">_query_rank</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="c1">// 这个树中小于 val 的节点的数量</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="c1">// 如果这个节点就是要查的节点</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">_query_rank</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// 如果左子树是空的，说比最小的节点还要小，那这个数字就是最小的</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">      </span><span class="c1">// 如果要查的值比这个节点大，那这个节点的左子树以及这个节点自身肯定都比要查的值小</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">      </span><span class="c1">// 所以要加上这两个值，再加上往右边找的结果</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">      </span><span class="c1">// （以右子树为根的子树中，val 这个值的大小的排名）</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_query_rank</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="c1">// 没有右子树的话直接整个树 + 1 相当于 less_siz + cur-&gt;rep_cnt + 1</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_9">根据排名查询值<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>要根据排名查询值，我们首先要知道如何判断要查的节点在树的哪个部分：</p>
<p>以下是一个判断方法的表：</p>
<table>
<thead>
<tr>
<th>左子树</th>
<th>根节点/当前节点</th>
<th>右子树</th>
</tr>
</thead>
<tbody>
<tr>
<td>排名 ≤ 左子树的大小</td>
<td>排名 &gt; 左子树的大小，并且 ≤ 左子树的大小 + 根节点的重复次数</td>
<td>排名 &gt; 左子树的大小 + 根节点的重复次数</td>
</tr>
</tbody>
</table>
<p>注意如果在右子树，递归的时候需要对原来的 <code>rank</code> 进行处理。递归的时候就相当去查，在右子树中为这个排名的值，为了把排名转换成基于右子树的，需要把原来的 <code>rank</code> 减去左子树的大小和根节点的重复次数。</p>
<p>可以把所有节点想象成一个排好序的数组，或者数轴（如下），</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>1 -&gt; |左子树的节点|根节点|右子树的节点| -&gt; n
                           ^
                           要查的排名
                     ⬇转换成基于右子树的排名
1 -&gt; |右子树的节点| -&gt; n
       ^
       要查的排名
</code></pre></div></td></tr></table></div>
<p>这里的转换方法就是直接把排名减去左子树的大小和根节点的重复数量。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">_query_val</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">  </span><span class="c1">// 查询树中第 rank 大的节点的值</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">  </span><span class="c1">// less siz 是左子树的大小</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">less_siz</span><span class="p">)</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_query_val</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">rank</span><span class="p">);</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="p">)</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="k">else</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_query_val</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="p">);</span><span class="w">  </span><span class="c1">// 见前文</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="val">查询第一个比 val 小的节点<a class="headerlink" href="#val" title="Permanent link">&para;</a></h3>
<p>注意这里使用了一个类中的全局变量，<code>q_prev_tmp</code>。</p>
<p>这个值是只有在 val 比当前节点值大的时候才会被更改的，所以返回这个变量就是返回 val 最后一次比当前节点的值大，之后就是更小了。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">_query_prev</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="c1">// 还是比 val 大，所以往左子树找</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_prev</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="c1">// 只有能进到这个 else 里，才会更新 q_prev_tmp 的值</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="n">q_prev_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="c1">// 当前节点已经比 val，小了，但是不确定是否是最大的，所以要到右子树继续找</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">_query_prev</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="c1">// 接下来的递归可能不会更改 q_prev_tmp</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="c1">// 了，那就直接返回这个值，总之返回的就是最后一次进到 这个 else 中的</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="c1">// cur-&gt;val</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">q_prev_tmp</span><span class="p">;</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">NIL</span><span class="p">;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="val_1">查询第一个比 val 大的节点<a class="headerlink" href="#val_1" title="Permanent link">&para;</a></h3>
<p>跟前一个很相似，只是大于小于号换了一下。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">_query_nex</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_nex</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="n">q_nex_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">_query_nex</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">q_nex_tmp</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">NIL</span><span class="p">;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="treap_2">无旋 treap<a class="headerlink" href="#treap_2" title="Permanent link">&para;</a></h2>
<p>无旋 treap 的操作方式使得它天生支持维护序列、可持久化等特性。</p>
<p><strong>无旋 treap</strong> 又称分裂合并 treap。它仅有两种核心操作，即为 <strong>分裂</strong> 与 <strong>合并</strong>。通过这两种操作，在很多情况下可以比旋转 treap 更方便的实现别的操作。下面逐一介绍这两种操作。</p>
<details class="note" open="open">
<summary>注释</summary>
<p>讲解无旋 treap 应当提到 <strong>FHQ-Treap</strong>（by 范浩强）。即可持久化，支持区间操作的无旋 Treap。更多内容请参照《范浩强谈数据结构》ppt。</p>
</details>
<h3 id="split">分裂（split）<a class="headerlink" href="#split" title="Permanent link">&para;</a></h3>
<h4 id="_10">按值分裂<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>分裂过程接受两个参数：根指针 <span class="arithmatex">\(\textit{cur}\)</span>、关键值 <span class="arithmatex">\(\textit{key}\)</span>。结果为将根指针指向的 treap 分裂为两个 treap，第一个 treap 所有结点的值（<span class="arithmatex">\(\textit{val}\)</span>）小于等于 <span class="arithmatex">\(\textit{key}\)</span>，第二个 treap 所有结点的值大于 <span class="arithmatex">\(\textit{key}\)</span>。</p>
<p>该过程首先判断 <span class="arithmatex">\(\textit{key}\)</span> 是否小于 <span class="arithmatex">\(\textit{cur}\)</span> 的值，若小于，则说明 <span class="arithmatex">\(\textit{cur}\)</span> 及其右子树全部大于 <span class="arithmatex">\(\textit{key}\)</span>，属于第二个 treap。当然，也可能有一部分的左子树的值大于 <span class="arithmatex">\(\textit{key}\)</span>，所以还需要继续向左子树递归地分裂。对于大于 <span class="arithmatex">\(\textit{key}\)</span> 的那部分左子树，我们把它作为 <span class="arithmatex">\(\textit{cur}\)</span> 的左子树，这样，整个 <span class="arithmatex">\(\textit{cur}\)</span> 上的节点都是大于 <span class="arithmatex">\(\textit{key}\)</span> 的。</p>
<p>相应的，如果 <span class="arithmatex">\(\textit{key}\)</span> 大于等于 <span class="arithmatex">\(\textit{cur}\)</span> 的值，说明 <span class="arithmatex">\(\textit{cur}\)</span> 的整个左子树以及其自身都小于 <span class="arithmatex">\(\textit{key}\)</span>，属于分裂后的第一个 treap。并且，<span class="arithmatex">\(\textit{cur}\)</span> 的部分右子树也可能有部分小于 <span class="arithmatex">\(\textit{key}\)</span>，因此我们需要继续递归地分裂右子树。把小于 <span class="arithmatex">\(\textit{key}\)</span> 的那部分作为 <span class="arithmatex">\(\textit{cur}\)</span> 的右子树，这样，整个 <span class="arithmatex">\(\textit{cur}\)</span> 上的节点都小于 <span class="arithmatex">\(\textit{key}\)</span>。</p>
<p>下图展示了 <span class="arithmatex">\(\textit{cur}\)</span> 的值小于等于 <span class="arithmatex">\(\textit{key}\)</span> 时按值分裂的情况。<sup id="fnref:ref1"><a class="footnote-ref" href="#fn:ref1">1</a></sup></p>
<p><img alt="按值分裂" src="../images/treap-none-rot-split-by-val.svg" /></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="c1">// cur 以及它的左子树一定属于分裂后的第一个树</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="c1">// 但是它可能有部分右子树也比 key 小</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="c1">// 我们把小于 key 的那部分拿出来，作为 cur 的右子树，这样整个 cur 都是小于</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="c1">// key 的 剩下的那部分右子树成为分裂后的第二个 treap</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="c1">// 分裂过后树的大小会变化，需要更新</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">};</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="c1">// 同上</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">};</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="_11">按排名分裂<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>比起按值分裂，这个操作更像是旋转 treap 中的根据排名（某个节点的排名是树中所有小于此节点值的节点的数量 <span class="arithmatex">\(+ 1\)</span>）查询值：</p>
<p>此函数接受两个参数，节点指针 <span class="arithmatex">\(\textit{cur}\)</span> 和排名 <span class="arithmatex">\(\textit{rk}\)</span>，返回分裂后的三个 treap。</p>
<p>其中，第一个 treap 中每个节点的排名都小于 <span class="arithmatex">\(\textit{rk}\)</span>，第二个的排名等于 <span class="arithmatex">\(\textit{rk}\)</span>，并且第二个 treap 只有一个节点（不可能有多个等于的，如果有的话会增加 <code>Node</code> 结构体中的 <code>cnt</code>），第三个则是大于。</p>
<p>此操作的重点在于判断排名和 <span class="arithmatex">\(\textit{cur}\)</span> 相等的节点在树的哪个部分，这也是旋转 treap 根据排名查询值操作时的重要部分，在前文有非常详细的解释，这里不过多讲解。</p>
<p>并且，此操作的递归部分和按值分裂也非常相似，这里不赘述。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">tuple</span><span class="o">&lt;</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ls_siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ls_siz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="c1">// 排名和 cur 相等的节点在左子树</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="n">tie</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">rk</span><span class="p">);</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span><span class="w">  </span><span class="c1">// 返回的第三个 treap 中的排名都大于 rk</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="c1">// cur 的左子树被设成 r 后，整个 cur 中节点的排名都大于 rk</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">};</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ls_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="c1">// 和 cur 相等的就是当前节点</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">lt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="c1">// 分裂后第二个 treap 只有一个节点，所有要把它的子树设置为空</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">lt</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">rt</span><span class="p">};</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">    </span><span class="c1">// 排名和 cur 相等的节点在右子树</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">    </span><span class="c1">// 递归过程同上</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="n">tie</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">rk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ls_siz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">);</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="p">;</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">};</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="merge">合并（merge）<a class="headerlink" href="#merge" title="Permanent link">&para;</a></h3>
<p>合并过程接受两个参数：左 treap 的根指针 <span class="arithmatex">\(\textit{u}\)</span>、右 treap 的根指针 <span class="arithmatex">\(\textit{v}\)</span>。必须满足 <span class="arithmatex">\(\textit{u}\)</span> 中所有结点的值小于等于 <span class="arithmatex">\(\textit{v}\)</span> 中所有结点的值。一般来说，我们合并的两个 treap 都是原来从一个 treap 中分裂出去的，所以不难满足 <span class="arithmatex">\(\textit{u}\)</span> 中所有节点的值都小于 <span class="arithmatex">\(\textit{v}\)</span></p>
<p>在旋转 treap 中，我们借助旋转操作来维护 <span class="arithmatex">\(\textit{priority}\)</span> 符合堆的性质，同时旋转时还不能改变树的性质。在无旋 treap 中，我们用合并达到相同的效果。</p>
<p>因为两个 treap 已经有序，所以我们在合并的时候只需要考虑把哪个树「放在上面」，把哪个「放在下面」，也就是是需要判断将哪个一个树作为子树。显然，根据堆的性质，我们需要把 <span class="arithmatex">\(\textit{priority}\)</span> 小的放在上面（这里采用小根堆）。</p>
<p>同时，我们还需要满足搜索树的性质，所以若 <span class="arithmatex">\(\textit{u}\)</span> 的根结点的 <span class="arithmatex">\(\textit{priority}\)</span> 小于 <span class="arithmatex">\(\textit{v}\)</span> 的，那么 <span class="arithmatex">\(\textit{u}\)</span> 即为新根结点，并且 <span class="arithmatex">\(\textit{v}\)</span> 因为值比 <span class="arithmatex">\(\textit{u}\)</span> 更大，应与 <span class="arithmatex">\(\textit{u}\)</span> 的右子树合并；反之，则 <span class="arithmatex">\(\textit{v}\)</span> 作为新根结点，然后因为 <span class="arithmatex">\(u\)</span> 的值比 <span class="arithmatex">\(\textit{v}\)</span> 小，与 <span class="arithmatex">\(v\)</span> 的左子树合并。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="nf">merge</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">  </span><span class="c1">// 传进来的两个树的内部已经符合搜索树的性质了</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">  </span><span class="c1">// 并且 u 内所有节点的值 &lt; v 内所有节点的值</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="c1">// 所以在合并的时候需要维护堆的性质</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">  </span><span class="c1">// 这里用的是小根堆</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="c1">// u 的 prio 比较小，u应该作为父节点</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span><span class="c1">// 因为 v 比 u 大，所以把 v 作为 u 的右子树</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="n">u</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="c1">// v 比较小，v应该作为父节点</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="c1">// u 比 v 小，所以递归时的参数是这样的</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_12">插入<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>在无旋 treap 中，插入，删除，根据值查询排名等基础操作既可以用普通二叉查找树的方法实现，也可以用分裂和合并来实现。通常来说，使用分裂和合并来实现更加简洁，但是速度会慢一点<sup id="fnref:ref2"><a class="footnote-ref" href="#fn:ref2">2</a></sup>。为了帮助更好的理解无旋 treap，下面的操作全部使用分裂和合并实现。</p>
<p>在实现插入操作时，我们利用了分裂操作的一些性质。也就是值小于等于 <span class="arithmatex">\(\textit{val}\)</span> 的节点会被分到第一个 treap。</p>
<p>所以，假设我们根据 <span class="arithmatex">\(\textit{val}\)</span> 分裂当前这个 treap。会有下面两棵树，并符合以下条件：</p>
<div class="arithmatex">\[
\begin{aligned}
T_1 &amp;\le val\\
T_2 &amp;&gt; val
\end{aligned}
\]</div>
<p>其中 <span class="arithmatex">\(T_1\)</span> 表示分裂后所有被分到第一个 treap 的节点的集合，<span class="arithmatex">\(T_2\)</span> 则是第二个。</p>
<p>如果我们再按照 <span class="arithmatex">\(\textit{val} - 1\)</span> 继续分裂 <span class="arithmatex">\(T_1\)</span>，那么会产生下面两棵树，并符合以下条件：</p>
<div class="arithmatex">\[
\begin{gathered}
T_{1\ \text{left}} \le val - 1\\
T_{1\ \text{right}} &gt; val - 1 \ \And \ T_{1\ \text{right}} \le val
\end{gathered}
\]</div>
<p>其中 <span class="arithmatex">\(T_{1\ \text{left}}\)</span> 表示 <span class="arithmatex">\(T_1\)</span> 分裂后所有被分到第一个 treap 的节点的集合，<span class="arithmatex">\(T_{1\ \text{right}}\)</span> 则是第二个。并且上面的式子中，后半部分的 <span class="arithmatex">\(\And \ T_{1\ \text{right}} \le val\)</span> 来自于 <span class="arithmatex">\(T_1\)</span> 所符合的条件 <span class="arithmatex">\(T_1 \le val\)</span>。</p>
<p>不难发现，只要 <span class="arithmatex">\(\textit{val}\)</span> 和节点的值是一个整数（大多数使用场景下会使用整数）那么符合 <span class="arithmatex">\(T_{1\ \text{right}}\)</span> 条件的节点只有一个，也就是值等于 <span class="arithmatex">\(\textit{val}\)</span> 的节点。</p>
<p>在插入时，如果我们发现符合 <span class="arithmatex">\(T_{1\ \text{right}}\)</span> 的节点存在，那就可以直接增加重复次数，否则，就新开一个节点。</p>
<p>注意把树分裂好了还需要用合并操作把它「粘」回去，这样下次还能继续使用。并且，还需要注意合并操作的参数顺序是有要求的，第一个树的所有节点的值都需要小于第二个。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">  </span><span class="c1">// 根据 val 的值把整个树分成两个</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">  </span><span class="c1">// 注意 split 的实现，等于 val 的子树是在左子树的</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">l_tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">  </span><span class="c1">// l_tr 的左子树 &lt;= val - 1，如果有 = val 的节点，那一定在右子树</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">new_node</span><span class="p">;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="c1">// 没有这个节点就新开，否则直接增加重复次数。</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l_tr_combined</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">      </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">new_node</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">  </span><span class="c1">// 合并 T_1 left 和 T_1 right</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr_combined</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">  </span><span class="c1">// 合并 T_1 和 T_2</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_13">删除<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>删除操作也使用和插入操作相似的方法，找到值和 <span class="arithmatex">\(\textit{val}\)</span> 相等的节点，并且删除它。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">del</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">l_tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="c1">// 如果这个节点的重复次数大于 1，减小即可</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">      </span><span class="c1">// 有可能整个 T_1 只有这个节点，所以也需要把这个点设成 null 来标注已经删除</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">      </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">    </span><span class="k">delete</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">    </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_14">根据值查询排名<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>排名是比这个值小的节点的数量 <span class="arithmatex">\(+ 1\)</span>，所以我们根据 <span class="arithmatex">\(\textit{val} - 1\)</span> 分裂当前树，那么分裂后的第一个树就符合：</p>
<div class="arithmatex">\[
T_1 \le val - 1
\]</div>
<p>如果树的值和 <span class="arithmatex">\(\textit{val}\)</span> 为整数，那么 <span class="arithmatex">\(T_1\)</span> 就包含了所有值小于 <span class="arithmatex">\(\textit{val}\)</span> 的节点。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">qrank_by_val</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// 根据定义 + 1</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w">  </span><span class="c1">// 拆好了再粘回去</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_15">根据排名查询值<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>调用 <code>split_by_rk()</code> 函数后，会返回分裂好的三个 treap，其中第二个只包含一个节点，它的排名等于 <span class="arithmatex">\(\textit{rk}\)</span>，所以我们直接返回这个节点的 <span class="arithmatex">\(\textit{val}\)</span>。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span>
<span class="normal"><a href="#__codelineno-15-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">qval_by_rank</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">  </span><span class="n">tie</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">rk</span><span class="p">);</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="val_2">查询第一个比 val 小的节点<a class="headerlink" href="#val_2" title="Permanent link">&para;</a></h3>
<p>可以把这个问题转化为，在比 <span class="arithmatex">\(\textit{val}\)</span> 小的所有节点中，找出排名最大的。我们根据 <span class="arithmatex">\(\textit{val}\)</span> 来分裂这个 treap，返回的第一个 treap 中的节点的值就全部小于 <span class="arithmatex">\(\textit{val}\)</span>，然后我们调用 <code>qval_by_rank()</code> 找出这个树中值最大的节点。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span>
<span class="normal"><a href="#__codelineno-16-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">qprev</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="c1">// temp.first 就是值小于 val 的子树</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qval_by_rank</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">);</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="c1">// 这里查询的是，所有小于 val 的节点里面，最大的那个的值</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="val_3">查询第一个比 val 大的节点<a class="headerlink" href="#val_3" title="Permanent link">&para;</a></h3>
<p>和上个操作类似，可以把这个问题转化为，在比 <span class="arithmatex">\(\textit{val}\)</span> 大的所有节点中，找出排名最小的。那么根据 <span class="arithmatex">\(\textit{val}\)</span> 分裂后，返回的第二个 treap 中的所有节点的值就大于 <span class="arithmatex">\(\textit{val}\)</span>。</p>
<p>然后我们去查询这个树中排名为 <span class="arithmatex">\(1\)</span> 的节点（也就是值最小的节点）的值，就可以成功查到第一个比 <span class="arithmatex">\(\textit{val}\)</span> 大的节点。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">qnex</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qval_by_rank</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">  </span><span class="c1">// 查询所有大于 val 的子树里面，值最小的那个</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="build">建树（build）<a class="headerlink" href="#build" title="Permanent link">&para;</a></h3>
<p>将一个有 <span class="arithmatex">\(n\)</span> 个节点的序列 <span class="arithmatex">\(\{a_n\}\)</span> 转化为一棵 treap。</p>
<p>可以依次暴力插入这 <span class="arithmatex">\(n\)</span> 个节点，每次插入一个权值为 <span class="arithmatex">\(v\)</span> 的节点时，将整棵 treap 按照权值分裂成权值小于等于 <span class="arithmatex">\(v\)</span> 的和权值大于 <span class="arithmatex">\(v\)</span> 的两部分，然后新建一个权值为 <span class="arithmatex">\(v\)</span> 的节点，将两部分和新节点按从小到大的顺序依次合并，单次插入时间复杂度 <span class="arithmatex">\(O(\log n)\)</span>，总时间复杂度 <span class="arithmatex">\(O(n\log n)\)</span>。</p>
<p>在某些题目内，可能会有多次插入一段有序序列的操作，这是就需要在 <span class="arithmatex">\(O(n)\)</span> 的时间复杂度内完成建树操作。</p>
<p>方法一：在递归建树的过程中，每次选取当前区间的中点作为该区间的树根，并对每个节点钦定合适的优先值，使得新树满足堆的性质。这样能保证树高为 <span class="arithmatex">\(O(\log n)\)</span>。</p>
<p>方法二：在递归建树的过程中，每次选取当前区间的中点作为该区间的树根，然后给每个节点一个随机优先级。这样能保证树高为 <span class="arithmatex">\(O(\log n)\)</span>，但不保证其满足堆的性质。这样也是正确的，因为无旋式 treap 的优先级是用来使 <code>merge</code> 操作更加随机一点，而不是用来保证树高的。</p>
<p>方法三：观察到 treap 是笛卡尔树，利用笛卡尔树的 <span class="arithmatex">\(O(n)\)</span> 建树方法即可，用单调栈维护右链即可。</p>
<h3 id="treap_3">无旋 treap 的区间操作<a class="headerlink" href="#treap_3" title="Permanent link">&para;</a></h3>
<h4 id="_16">建树<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>无旋 treap 相比旋转 treap 的一大好处就是可以实现各种区间操作，下面我们以文艺平衡树的 <a href="https://loj.ac/problem/105">模板题</a> 为例，介绍 treap 的区间操作。</p>
<blockquote>
<p>您需要写一种数据结构（可参考题目标题），来维护一个有序数列。</p>
<p>其中需要提供以下操作：翻转一个区间，例如原有序序列是 <span class="arithmatex">\(5\ 4\ 3\ 2\ 1\)</span>，翻转区间是 <span class="arithmatex">\([2,4]\)</span> 的话，结果是 <span class="arithmatex">\(5\ 2\ 3\ 4\ 1\)</span>。
对于 <span class="arithmatex">\(100\%\)</span> 的数据，<span class="arithmatex">\(1 \le n\)</span>（初始区间长度）<span class="arithmatex">\(m\)</span>（翻转次数）<span class="arithmatex">\(\le 10^5\)</span></p>
</blockquote>
<p>在这道题目中，我们需要实现的是区间翻转，那么我们首先需要考虑如何建树，建出来的树需要是初始的区间。</p>
<p>我们只需要把区间的下标依次插入 treap 中，这样在中序遍历（先遍历左子树，然后当前节点，最后右子树）时，就可以得到这个区间<sup id="fnref:ref3"><a class="footnote-ref" href="#fn:ref3">3</a></sup>。</p>
<p>我们知道在朴素的二叉查找树中按照递增的顺序插入节点，建出来的树是一个长链，按照中序遍历，自然可以得到这个区间。</p>
<div align=center>
  <img style="width: 50%; " src="../images/treap-search-tree-chain.svg" >
</div>

<p>如上图，按照 <span class="arithmatex">\(1\ 2\ 3\ 4\ 5\)</span> 的顺序给朴素搜索树插入节点，中序遍历时，得到的也是 <span class="arithmatex">\(1\ 2\ 3\ 4\ 5\)</span>。</p>
<p>但是在 treap 中，按增序插入节点后，在合并操作时还会根据 <span class="arithmatex">\(\textit{priority}\)</span> 调整树的结构，在这样的情况下，如何确保中序遍历一定能正确的输出呢？</p>
<p>可以参考 <a href="../cartesian-tree/">笛卡尔树的单调栈建树方法</a> 来理解这个问题。</p>
<p>设新插入的节点为 <span class="arithmatex">\(\textit{u}\)</span>。</p>
<p>首先，因为是递增地插入节点，每一个新插入的节点肯定会被连接到 treap 的右链（即从根结点一直往右子树走，经过的结点形成的链）上。</p>
<p>从根节点开始，右链上的节点的 <span class="arithmatex">\(\textit{priority}\)</span> 是递增的（小根堆）。那我们可以找到右链上第一个 <span class="arithmatex">\(\textit{priority}\)</span> 大于 <span class="arithmatex">\(\textit{u}\)</span> 的节点，我们叫这个节点 <span class="arithmatex">\(\textit{v}\)</span>，并把这个节点换成 <span class="arithmatex">\(\textit{u}\)</span>。</p>
<p>因为 <span class="arithmatex">\(\textit{u}\)</span> 一定大于这个树上其他的全部节点，我们需要把 <span class="arithmatex">\(\textit{v}\)</span> 以及它的子树作为 <span class="arithmatex">\(\textit{u}\)</span> 的左子树。并且此时 <span class="arithmatex">\(\textit{u}\)</span> 没有右子树。</p>
<p>可以发现，中序遍历时 <span class="arithmatex">\(\textit{u}\)</span> 一定是最后一个被遍历到的（因为 <span class="arithmatex">\(\textit{u}\)</span> 是右链中的最后一个，而中序遍历中，右子树是最后被遍历到的）。</p>
<p>下图是一个 treap 根据递增顺序插入 <span class="arithmatex">\(1 \sim 5\)</span> 号节点时，插入 <span class="arithmatex">\(5\)</span> 号节点时的变化，可以用这张图更好的理解按照增序插入的过程。</p>
<p><img alt="插入结点" src="../images/treap-none-rot-seg-build.svg" /></p>
<h4 id="_17">区间翻转<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<p>翻转 <span class="arithmatex">\([l, r]\)</span> 这个区间时，基本思路是将树分裂成 <span class="arithmatex">\([1, l - 1],\ [l, r],\ [r + 1, n]\)</span> 三个区间，再对中间的 <span class="arithmatex">\([l, r]\)</span> 进行翻转<sup id="fnref2:ref3"><a class="footnote-ref" href="#fn:ref3">3</a></sup>。</p>
<p>翻转的具体操作是把区间内的子树的每一个左，右子节点交换位置。如下图就展示了翻转上图中 treap 的 <span class="arithmatex">\([3, 4]\)</span> 和 <span class="arithmatex">\([3, 5]\)</span> 区间后的 treap。</p>
<p><img alt="区间翻转" src="../images/treap-none-rot-seg-flip-ex.svg" /></p>
<p>注意如果按照这个方法翻转，那么每次翻转 <span class="arithmatex">\([l, r]\)</span> 区间时，就会有 <span class="arithmatex">\(r - l\)</span> 个节点会被交换位置，这样频繁的操作显然不能满足 <span class="arithmatex">\(10^5\)</span> 的数据范围，其 <span class="arithmatex">\(O(n \times \log_2 n)\)</span> 的单次翻转复杂度甚至不如暴力（因为我们除了需要花线性时间交换节点外，还需要在树中花费 <span class="arithmatex">\(O(\log_2 n)\)</span> 的时间找到需要交换的节点）。</p>
<p>再观察题目要求，可以发现因为只需要最后输出操作完的区间，所以并不需要每次都真的去交换。如此一来，便可以使用线段树中常用的懒标记（lazy tag）来优化复杂度。交换时，只需要在父节点打上标记，代表这个子树下的每个左右子节点都需要交换就行了。</p>
<p>在线段树中，我们一般在更新和查询时下传懒标记。这是因为，在更新和查询时，我们想要更新/查询的范围不一定和懒标记代表的范围重合，所以要先下传标记，确保查到和更新后的值是正确的。</p>
<p>在无旋 treap 中也是一样。具体操作时我们会把 treap 分裂成前文讲到的三个树，然后给中间的树打上懒标记后合并这三棵树。因为我们想要翻转的区间和懒标记代表的区间不一定重合，所以要在分裂时下传标记。并且，分裂和合并操作会造成每个节点及其懒标记所代表的节点发生变动，所以也需要在合并前下传懒标记。</p>
<p>换句话说，是当树的结构发生改变的时候，当我们进行分裂或合并操作时需要改变某一个点的左右儿子信息时之前，应该下放标记，而非之后，因为懒标记是需要下传给儿子节点的，但更改左右儿子信息之后若懒标记还未下放，则懒标记就丢失了下放的对象。<sup id="fnref:ref4"><a class="footnote-ref" href="#fn:ref4">4</a></sup></p>
<!-- TODO: 可以加一张图解释为什么需要在分裂和合并时下传标记 -->

<p>以下为代码讲解，代码参考了<sup id="fnref3:ref3"><a class="footnote-ref" href="#fn:ref3">3</a></sup>。</p>
<p>因为区间操作中大部分操作都和普通的无旋 treap 相同，所以这里只讲解和普通无旋 treap 不同的地方。</p>
<h4 id="_18">下传标记<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>需要注意这里的懒标记代表需要把这个树中的每一个子节点交换位置。所以如果当前节点的子节点也有懒标记，那两次翻转就抵消了。如果子节点不需要翻转，那么这个懒标记就需要继续被下传到子节点上。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1">// 这里这个 pushdown 是 Node 类的成员函数，其中 to_rev 是懒标记</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pushdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">  </span><span class="n">swap</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">to_rev</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">to_rev</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">  </span><span class="n">to_rev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="p">}</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">check_tag</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">to_rev</span><span class="p">)</span><span class="w"> </span><span class="n">pushdown</span><span class="p">();</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="_19">分裂<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<p>注意在这个题目中，因为翻转操作，treap 中的 <span class="arithmatex">\(\textit{val}\)</span> 会不符合二叉搜索树的性质（见区间翻转部分的图），所以我们不能根据 <span class="arithmatex">\(\textit{val}\)</span> 来判断应该往左子树还是右子树递归。</p>
<p>所以这里的分裂跟普通无旋 treap 中的按排名分裂更相似，是根据当前树的大小判断往左还是右子树递归的，换言之，我们是按照开始时这个节点在树中的位置来判断的。</p>
<p>返回的第一个 treap 中节点的排名全部小于等于 <span class="arithmatex">\(\textit{sz}\)</span>，而第二个 treap 中节点的排名则全部大于 <span class="arithmatex">\(\textit{sz}\)</span>。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="cp">#define siz(_) (_ == nullptr ? 0 : _-&gt;siz)</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">  </span><span class="c1">// 按照树的大小判断</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">  </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">();</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">  </span><span class="c1">// 分裂前先下传</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">};</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">        </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">              </span><span class="n">sz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">                  </span><span class="mi">1</span><span class="p">);</span><span class="w">  </span><span class="c1">// 这里的转换在有旋 treap 的 「根据排名查询值有讲」</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">};</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="_20">合并<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>唯一需要注意的是在合并前下传懒标记</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="nf">merge</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">sm</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">bg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">  </span><span class="c1">// small, big</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">sm</span><span class="p">;</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">bg</span><span class="p">;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">  </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">(),</span><span class="w"> </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">();</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">    </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">bg</span><span class="p">);</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">    </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">sm</span><span class="p">;</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="w">    </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span><span class="w"> </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a><span class="w">    </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bg</span><span class="p">;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="_21">区间翻转<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<p>和前面介绍的一样，分裂出 <span class="arithmatex">\([1, l - 1],\ [l, r],\ [r + 1, n]\)</span> 三个区间，然后对中间的区间打上标记后再合并。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span>
<span class="normal"><a href="#__codelineno-21-8">8</a></span>
<span class="normal"><a href="#__codelineno-21-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">seg_rev</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">  </span><span class="c1">// 这里的 less 和 more 是相对于 l 的</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">  </span><span class="c1">// 所有小于等于 l - 1 的会在 less 的左子树</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">less</span><span class="p">.</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="w">  </span><span class="c1">// 从 l 开始的前 r - l + 1 个元素的区间</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="w">  </span><span class="n">more</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">to_rev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">less</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">more</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">more</span><span class="p">.</span><span class="n">second</span><span class="p">));</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h4 id="_22">中序遍历打印<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>要注意在打印时要下传标记。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span>
<span class="normal"><a href="#__codelineno-22-6">6</a></span>
<span class="normal"><a href="#__codelineno-22-7">7</a></span>
<span class="normal"><a href="#__codelineno-22-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">print</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">  </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">();</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">  </span><span class="c1">// 中序遍历 -&gt; 先左子树，再自己，最后右子树</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">  </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">  </span><span class="n">print</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="_23">完整代码<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h2>
<h3 id="treap_4">旋转 treap<a class="headerlink" href="#treap_4" title="Permanent link">&para;</a></h3>
<h4 id="_24">指针实现<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<details class="note">
<summary>完整代码</summary>
<p>以下是前文讲解的代码的完整版本，是普通平衡树的模板代码。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">  1</a></span>
<span class="normal"><a href="#__codelineno-23-2">  2</a></span>
<span class="normal"><a href="#__codelineno-23-3">  3</a></span>
<span class="normal"><a href="#__codelineno-23-4">  4</a></span>
<span class="normal"><a href="#__codelineno-23-5">  5</a></span>
<span class="normal"><a href="#__codelineno-23-6">  6</a></span>
<span class="normal"><a href="#__codelineno-23-7">  7</a></span>
<span class="normal"><a href="#__codelineno-23-8">  8</a></span>
<span class="normal"><a href="#__codelineno-23-9">  9</a></span>
<span class="normal"><a href="#__codelineno-23-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-23-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-23-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-23-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-23-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-23-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-23-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-23-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-23-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-23-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-23-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-23-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-23-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-23-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-23-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-23-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-23-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-23-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-23-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-23-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-23-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-23-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-23-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-23-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-23-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-23-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-23-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-23-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-23-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-23-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-23-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-23-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-23-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-23-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-23-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-23-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-23-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-23-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-23-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-23-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-23-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-23-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-23-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-23-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-23-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-23-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-23-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-23-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-23-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-23-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-23-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-23-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-23-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-23-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-23-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-23-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-23-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-23-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-23-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-23-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-23-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-23-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-23-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-23-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-23-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-23-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-23-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-23-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-23-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-23-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-23-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-23-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-23-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-23-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-23-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-23-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-23-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-23-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-23-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-23-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-23-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-23-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-23-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-23-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-23-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-23-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-23-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-23-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-23-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-23-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-23-100">100</a></span>
<span class="normal"><a href="#__codelineno-23-101">101</a></span>
<span class="normal"><a href="#__codelineno-23-102">102</a></span>
<span class="normal"><a href="#__codelineno-23-103">103</a></span>
<span class="normal"><a href="#__codelineno-23-104">104</a></span>
<span class="normal"><a href="#__codelineno-23-105">105</a></span>
<span class="normal"><a href="#__codelineno-23-106">106</a></span>
<span class="normal"><a href="#__codelineno-23-107">107</a></span>
<span class="normal"><a href="#__codelineno-23-108">108</a></span>
<span class="normal"><a href="#__codelineno-23-109">109</a></span>
<span class="normal"><a href="#__codelineno-23-110">110</a></span>
<span class="normal"><a href="#__codelineno-23-111">111</a></span>
<span class="normal"><a href="#__codelineno-23-112">112</a></span>
<span class="normal"><a href="#__codelineno-23-113">113</a></span>
<span class="normal"><a href="#__codelineno-23-114">114</a></span>
<span class="normal"><a href="#__codelineno-23-115">115</a></span>
<span class="normal"><a href="#__codelineno-23-116">116</a></span>
<span class="normal"><a href="#__codelineno-23-117">117</a></span>
<span class="normal"><a href="#__codelineno-23-118">118</a></span>
<span class="normal"><a href="#__codelineno-23-119">119</a></span>
<span class="normal"><a href="#__codelineno-23-120">120</a></span>
<span class="normal"><a href="#__codelineno-23-121">121</a></span>
<span class="normal"><a href="#__codelineno-23-122">122</a></span>
<span class="normal"><a href="#__codelineno-23-123">123</a></span>
<span class="normal"><a href="#__codelineno-23-124">124</a></span>
<span class="normal"><a href="#__codelineno-23-125">125</a></span>
<span class="normal"><a href="#__codelineno-23-126">126</a></span>
<span class="normal"><a href="#__codelineno-23-127">127</a></span>
<span class="normal"><a href="#__codelineno-23-128">128</a></span>
<span class="normal"><a href="#__codelineno-23-129">129</a></span>
<span class="normal"><a href="#__codelineno-23-130">130</a></span>
<span class="normal"><a href="#__codelineno-23-131">131</a></span>
<span class="normal"><a href="#__codelineno-23-132">132</a></span>
<span class="normal"><a href="#__codelineno-23-133">133</a></span>
<span class="normal"><a href="#__codelineno-23-134">134</a></span>
<span class="normal"><a href="#__codelineno-23-135">135</a></span>
<span class="normal"><a href="#__codelineno-23-136">136</a></span>
<span class="normal"><a href="#__codelineno-23-137">137</a></span>
<span class="normal"><a href="#__codelineno-23-138">138</a></span>
<span class="normal"><a href="#__codelineno-23-139">139</a></span>
<span class="normal"><a href="#__codelineno-23-140">140</a></span>
<span class="normal"><a href="#__codelineno-23-141">141</a></span>
<span class="normal"><a href="#__codelineno-23-142">142</a></span>
<span class="normal"><a href="#__codelineno-23-143">143</a></span>
<span class="normal"><a href="#__codelineno-23-144">144</a></span>
<span class="normal"><a href="#__codelineno-23-145">145</a></span>
<span class="normal"><a href="#__codelineno-23-146">146</a></span>
<span class="normal"><a href="#__codelineno-23-147">147</a></span>
<span class="normal"><a href="#__codelineno-23-148">148</a></span>
<span class="normal"><a href="#__codelineno-23-149">149</a></span>
<span class="normal"><a href="#__codelineno-23-150">150</a></span>
<span class="normal"><a href="#__codelineno-23-151">151</a></span>
<span class="normal"><a href="#__codelineno-23-152">152</a></span>
<span class="normal"><a href="#__codelineno-23-153">153</a></span>
<span class="normal"><a href="#__codelineno-23-154">154</a></span>
<span class="normal"><a href="#__codelineno-23-155">155</a></span>
<span class="normal"><a href="#__codelineno-23-156">156</a></span>
<span class="normal"><a href="#__codelineno-23-157">157</a></span>
<span class="normal"><a href="#__codelineno-23-158">158</a></span>
<span class="normal"><a href="#__codelineno-23-159">159</a></span>
<span class="normal"><a href="#__codelineno-23-160">160</a></span>
<span class="normal"><a href="#__codelineno-23-161">161</a></span>
<span class="normal"><a href="#__codelineno-23-162">162</a></span>
<span class="normal"><a href="#__codelineno-23-163">163</a></span>
<span class="normal"><a href="#__codelineno-23-164">164</a></span>
<span class="normal"><a href="#__codelineno-23-165">165</a></span>
<span class="normal"><a href="#__codelineno-23-166">166</a></span>
<span class="normal"><a href="#__codelineno-23-167">167</a></span>
<span class="normal"><a href="#__codelineno-23-168">168</a></span>
<span class="normal"><a href="#__codelineno-23-169">169</a></span>
<span class="normal"><a href="#__codelineno-23-170">170</a></span>
<span class="normal"><a href="#__codelineno-23-171">171</a></span>
<span class="normal"><a href="#__codelineno-23-172">172</a></span>
<span class="normal"><a href="#__codelineno-23-173">173</a></span>
<span class="normal"><a href="#__codelineno-23-174">174</a></span>
<span class="normal"><a href="#__codelineno-23-175">175</a></span>
<span class="normal"><a href="#__codelineno-23-176">176</a></span>
<span class="normal"><a href="#__codelineno-23-177">177</a></span>
<span class="normal"><a href="#__codelineno-23-178">178</a></span>
<span class="normal"><a href="#__codelineno-23-179">179</a></span>
<span class="normal"><a href="#__codelineno-23-180">180</a></span>
<span class="normal"><a href="#__codelineno-23-181">181</a></span>
<span class="normal"><a href="#__codelineno-23-182">182</a></span>
<span class="normal"><a href="#__codelineno-23-183">183</a></span>
<span class="normal"><a href="#__codelineno-23-184">184</a></span>
<span class="normal"><a href="#__codelineno-23-185">185</a></span>
<span class="normal"><a href="#__codelineno-23-186">186</a></span>
<span class="normal"><a href="#__codelineno-23-187">187</a></span>
<span class="normal"><a href="#__codelineno-23-188">188</a></span>
<span class="normal"><a href="#__codelineno-23-189">189</a></span>
<span class="normal"><a href="#__codelineno-23-190">190</a></span>
<span class="normal"><a href="#__codelineno-23-191">191</a></span>
<span class="normal"><a href="#__codelineno-23-192">192</a></span>
<span class="normal"><a href="#__codelineno-23-193">193</a></span>
<span class="normal"><a href="#__codelineno-23-194">194</a></span>
<span class="normal"><a href="#__codelineno-23-195">195</a></span>
<span class="normal"><a href="#__codelineno-23-196">196</a></span>
<span class="normal"><a href="#__codelineno-23-197">197</a></span>
<span class="normal"><a href="#__codelineno-23-198">198</a></span>
<span class="normal"><a href="#__codelineno-23-199">199</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c1">// author: (ttzytt)[ttzytt.com]</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdint&gt;</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">rep_cnt</span><span class="p">;</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">  </span><span class="n">Node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">val</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="w"> </span><span class="n">rep_cnt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">    </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">    </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">upd_siz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="w">    </span><span class="n">siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rep_cnt</span><span class="p">;</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="p">};</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">Treap</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w"> </span><span class="k">private</span><span class="o">:</span>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span>
<a id="__codelineno-23-28" name="__codelineno-23-28"></a>
<a id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="w">  </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NIL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w">  </span><span class="c1">// 用于表示查询的值不存在</span>
<a id="__codelineno-23-30" name="__codelineno-23-30"></a>
<a id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="w">  </span><span class="k">enum</span><span class="w"> </span><span class="nc">rot_type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">LF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">RT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<a id="__codelineno-23-32" name="__codelineno-23-32"></a>
<a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">q_prev_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">q_nex_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-34" name="__codelineno-23-34"></a>
<a id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">_rotate</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">rot_type</span><span class="w"> </span><span class="n">dir</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 0为右旋，1为左旋</span>
<a id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">dir</span><span class="p">];</span>
<a id="__codelineno-23-37" name="__codelineno-23-37"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">dir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">];</span>
<a id="__codelineno-23-38" name="__codelineno-23-38"></a><span class="w">    </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span>
<a id="__codelineno-23-39" name="__codelineno-23-39"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">(),</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-23-40" name="__codelineno-23-40"></a><span class="w">    </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-23-41" name="__codelineno-23-41"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-42" name="__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">_insert</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-44" name="__codelineno-23-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-45" name="__codelineno-23-45"></a><span class="w">      </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-46" name="__codelineno-23-46"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-23-47" name="__codelineno-23-47"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-48" name="__codelineno-23-48"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-23-49" name="__codelineno-23-49"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">siz</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-23-50" name="__codelineno-23-50"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-51" name="__codelineno-23-51"></a><span class="w">      </span><span class="n">_insert</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-52" name="__codelineno-23-52"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-53" name="__codelineno-23-53"></a><span class="w">        </span><span class="n">_rotate</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">RT</span><span class="p">);</span>
<a id="__codelineno-23-54" name="__codelineno-23-54"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-55" name="__codelineno-23-55"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-23-56" name="__codelineno-23-56"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-57" name="__codelineno-23-57"></a><span class="w">      </span><span class="n">_insert</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-58" name="__codelineno-23-58"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-59" name="__codelineno-23-59"></a><span class="w">        </span><span class="n">_rotate</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">LF</span><span class="p">);</span>
<a id="__codelineno-23-60" name="__codelineno-23-60"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-61" name="__codelineno-23-61"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-23-62" name="__codelineno-23-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-63" name="__codelineno-23-63"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-64" name="__codelineno-23-64"></a>
<a id="__codelineno-23-65" name="__codelineno-23-65"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">_del</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-66" name="__codelineno-23-66"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-67" name="__codelineno-23-67"></a><span class="w">      </span><span class="n">_del</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-68" name="__codelineno-23-68"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-23-69" name="__codelineno-23-69"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-70" name="__codelineno-23-70"></a><span class="w">      </span><span class="n">_del</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-71" name="__codelineno-23-71"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-23-72" name="__codelineno-23-72"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-73" name="__codelineno-23-73"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-74" name="__codelineno-23-74"></a><span class="w">        </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="o">--</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">siz</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-23-75" name="__codelineno-23-75"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-23-76" name="__codelineno-23-76"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-77" name="__codelineno-23-77"></a><span class="w">      </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-78" name="__codelineno-23-78"></a><span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>
<a id="__codelineno-23-79" name="__codelineno-23-79"></a><span class="w">      </span><span class="n">state</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">((</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-80" name="__codelineno-23-80"></a><span class="w">      </span><span class="c1">// 00都无，01有左无右，10，无左有右，11都有</span>
<a id="__codelineno-23-81" name="__codelineno-23-81"></a><span class="w">      </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span>
<a id="__codelineno-23-82" name="__codelineno-23-82"></a><span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-83" name="__codelineno-23-83"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-23-84" name="__codelineno-23-84"></a><span class="w">          </span><span class="k">delete</span><span class="w"> </span><span class="n">cur</span><span class="p">;</span>
<a id="__codelineno-23-85" name="__codelineno-23-85"></a><span class="w">          </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-23-86" name="__codelineno-23-86"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-87" name="__codelineno-23-87"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">  </span><span class="c1">// 有左无右</span>
<a id="__codelineno-23-88" name="__codelineno-23-88"></a><span class="w">          </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-23-89" name="__codelineno-23-89"></a><span class="w">          </span><span class="k">delete</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-23-90" name="__codelineno-23-90"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-91" name="__codelineno-23-91"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w">  </span><span class="c1">// 有右无左</span>
<a id="__codelineno-23-92" name="__codelineno-23-92"></a><span class="w">          </span><span class="n">cur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-23-93" name="__codelineno-23-93"></a><span class="w">          </span><span class="k">delete</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-23-94" name="__codelineno-23-94"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-95" name="__codelineno-23-95"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-23-96" name="__codelineno-23-96"></a><span class="w">          </span><span class="n">rot_type</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rank</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">RT</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">LF</span><span class="p">;</span>
<a id="__codelineno-23-97" name="__codelineno-23-97"></a><span class="w">          </span><span class="n">_rotate</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">);</span>
<a id="__codelineno-23-98" name="__codelineno-23-98"></a><span class="w">          </span><span class="n">_del</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="o">!</span><span class="n">dir</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-99" name="__codelineno-23-99"></a><span class="w">          </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-23-100" name="__codelineno-23-100"></a><span class="w">          </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-101" name="__codelineno-23-101"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-23-102" name="__codelineno-23-102"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-103" name="__codelineno-23-103"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-104" name="__codelineno-23-104"></a>
<a id="__codelineno-23-105" name="__codelineno-23-105"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">_query_rank</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-106" name="__codelineno-23-106"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-23-107" name="__codelineno-23-107"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
<a id="__codelineno-23-108" name="__codelineno-23-108"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-23-109" name="__codelineno-23-109"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-110" name="__codelineno-23-110"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<a id="__codelineno-23-111" name="__codelineno-23-111"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_query_rank</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-112" name="__codelineno-23-112"></a><span class="w">      </span><span class="k">else</span>
<a id="__codelineno-23-113" name="__codelineno-23-113"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-23-114" name="__codelineno-23-114"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-115" name="__codelineno-23-115"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span>
<a id="__codelineno-23-116" name="__codelineno-23-116"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_query_rank</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-117" name="__codelineno-23-117"></a><span class="w">      </span><span class="k">else</span>
<a id="__codelineno-23-118" name="__codelineno-23-118"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-23-119" name="__codelineno-23-119"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-120" name="__codelineno-23-120"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-121" name="__codelineno-23-121"></a>
<a id="__codelineno-23-122" name="__codelineno-23-122"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">_query_val</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-123" name="__codelineno-23-123"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-23-124" name="__codelineno-23-124"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">less_siz</span><span class="p">)</span>
<a id="__codelineno-23-125" name="__codelineno-23-125"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">_query_val</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">rank</span><span class="p">);</span>
<a id="__codelineno-23-126" name="__codelineno-23-126"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="p">)</span>
<a id="__codelineno-23-127" name="__codelineno-23-127"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-23-128" name="__codelineno-23-128"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-23-129" name="__codelineno-23-129"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">_query_val</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">less_siz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">rep_cnt</span><span class="p">);</span>
<a id="__codelineno-23-130" name="__codelineno-23-130"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-131" name="__codelineno-23-131"></a>
<a id="__codelineno-23-132" name="__codelineno-23-132"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">_query_prev</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-133" name="__codelineno-23-133"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-134" name="__codelineno-23-134"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_prev</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-135" name="__codelineno-23-135"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-136" name="__codelineno-23-136"></a><span class="w">      </span><span class="n">q_prev_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-23-137" name="__codelineno-23-137"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">_query_prev</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-138" name="__codelineno-23-138"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">q_prev_tmp</span><span class="p">;</span>
<a id="__codelineno-23-139" name="__codelineno-23-139"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-140" name="__codelineno-23-140"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NIL</span><span class="p">;</span>
<a id="__codelineno-23-141" name="__codelineno-23-141"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-142" name="__codelineno-23-142"></a>
<a id="__codelineno-23-143" name="__codelineno-23-143"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">_query_nex</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-144" name="__codelineno-23-144"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-145" name="__codelineno-23-145"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_nex</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-146" name="__codelineno-23-146"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-147" name="__codelineno-23-147"></a><span class="w">      </span><span class="n">q_nex_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-23-148" name="__codelineno-23-148"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">_query_nex</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-23-149" name="__codelineno-23-149"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">q_nex_tmp</span><span class="p">;</span>
<a id="__codelineno-23-150" name="__codelineno-23-150"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-151" name="__codelineno-23-151"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">NIL</span><span class="p">;</span>
<a id="__codelineno-23-152" name="__codelineno-23-152"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-153" name="__codelineno-23-153"></a>
<a id="__codelineno-23-154" name="__codelineno-23-154"></a><span class="w"> </span><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-23-155" name="__codelineno-23-155"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_insert</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-23-156" name="__codelineno-23-156"></a>
<a id="__codelineno-23-157" name="__codelineno-23-157"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">del</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_del</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-23-158" name="__codelineno-23-158"></a>
<a id="__codelineno-23-159" name="__codelineno-23-159"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">query_rank</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_rank</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-23-160" name="__codelineno-23-160"></a>
<a id="__codelineno-23-161" name="__codelineno-23-161"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">query_val</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_val</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-23-162" name="__codelineno-23-162"></a>
<a id="__codelineno-23-163" name="__codelineno-23-163"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">query_prev</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_prev</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-23-164" name="__codelineno-23-164"></a>
<a id="__codelineno-23-165" name="__codelineno-23-165"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">query_nex</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">_query_nex</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-23-166" name="__codelineno-23-166"></a><span class="p">};</span>
<a id="__codelineno-23-167" name="__codelineno-23-167"></a>
<a id="__codelineno-23-168" name="__codelineno-23-168"></a><span class="n">Treap</span><span class="w"> </span><span class="n">tr</span><span class="p">;</span>
<a id="__codelineno-23-169" name="__codelineno-23-169"></a>
<a id="__codelineno-23-170" name="__codelineno-23-170"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-171" name="__codelineno-23-171"></a><span class="w">  </span><span class="n">srand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-23-172" name="__codelineno-23-172"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<a id="__codelineno-23-173" name="__codelineno-23-173"></a><span class="w">  </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<a id="__codelineno-23-174" name="__codelineno-23-174"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-175" name="__codelineno-23-175"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="__codelineno-23-176" name="__codelineno-23-176"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
<a id="__codelineno-23-177" name="__codelineno-23-177"></a><span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
<a id="__codelineno-23-178" name="__codelineno-23-178"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-179" name="__codelineno-23-179"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-23-180" name="__codelineno-23-180"></a><span class="w">        </span><span class="n">tr</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<a id="__codelineno-23-181" name="__codelineno-23-181"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-182" name="__codelineno-23-182"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-23-183" name="__codelineno-23-183"></a><span class="w">        </span><span class="n">tr</span><span class="p">.</span><span class="n">del</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<a id="__codelineno-23-184" name="__codelineno-23-184"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-185" name="__codelineno-23-185"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-23-186" name="__codelineno-23-186"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">query_rank</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-23-187" name="__codelineno-23-187"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-188" name="__codelineno-23-188"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-23-189" name="__codelineno-23-189"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">query_val</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-23-190" name="__codelineno-23-190"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-191" name="__codelineno-23-191"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-23-192" name="__codelineno-23-192"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">query_prev</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-23-193" name="__codelineno-23-193"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-194" name="__codelineno-23-194"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-23-195" name="__codelineno-23-195"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">query_nex</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-23-196" name="__codelineno-23-196"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-23-197" name="__codelineno-23-197"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-198" name="__codelineno-23-198"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-23-199" name="__codelineno-23-199"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<h4 id="_25">数组实现<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>以下是 bzoj 普通平衡树模板代码，使用数组实现。</p>
<details class="note">
<summary>完整代码</summary>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a>
</code></pre></div></td></tr></table></div>
</details>
<h3 id="treap_5">无旋 treap<a class="headerlink" href="#treap_5" title="Permanent link">&para;</a></h3>
<h4 id="_26">指针实现<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<details class="note">
<summary>完整代码</summary>
<p>以下是前文讲解的代码的完整版本，是普通平衡树的模板代码。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">  1</a></span>
<span class="normal"><a href="#__codelineno-25-2">  2</a></span>
<span class="normal"><a href="#__codelineno-25-3">  3</a></span>
<span class="normal"><a href="#__codelineno-25-4">  4</a></span>
<span class="normal"><a href="#__codelineno-25-5">  5</a></span>
<span class="normal"><a href="#__codelineno-25-6">  6</a></span>
<span class="normal"><a href="#__codelineno-25-7">  7</a></span>
<span class="normal"><a href="#__codelineno-25-8">  8</a></span>
<span class="normal"><a href="#__codelineno-25-9">  9</a></span>
<span class="normal"><a href="#__codelineno-25-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-25-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-25-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-25-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-25-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-25-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-25-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-25-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-25-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-25-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-25-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-25-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-25-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-25-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-25-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-25-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-25-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-25-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-25-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-25-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-25-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-25-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-25-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-25-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-25-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-25-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-25-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-25-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-25-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-25-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-25-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-25-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-25-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-25-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-25-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-25-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-25-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-25-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-25-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-25-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-25-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-25-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-25-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-25-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-25-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-25-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-25-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-25-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-25-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-25-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-25-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-25-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-25-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-25-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-25-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-25-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-25-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-25-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-25-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-25-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-25-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-25-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-25-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-25-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-25-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-25-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-25-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-25-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-25-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-25-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-25-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-25-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-25-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-25-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-25-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-25-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-25-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-25-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-25-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-25-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-25-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-25-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-25-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-25-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-25-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-25-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-25-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-25-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-25-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-25-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-25-100">100</a></span>
<span class="normal"><a href="#__codelineno-25-101">101</a></span>
<span class="normal"><a href="#__codelineno-25-102">102</a></span>
<span class="normal"><a href="#__codelineno-25-103">103</a></span>
<span class="normal"><a href="#__codelineno-25-104">104</a></span>
<span class="normal"><a href="#__codelineno-25-105">105</a></span>
<span class="normal"><a href="#__codelineno-25-106">106</a></span>
<span class="normal"><a href="#__codelineno-25-107">107</a></span>
<span class="normal"><a href="#__codelineno-25-108">108</a></span>
<span class="normal"><a href="#__codelineno-25-109">109</a></span>
<span class="normal"><a href="#__codelineno-25-110">110</a></span>
<span class="normal"><a href="#__codelineno-25-111">111</a></span>
<span class="normal"><a href="#__codelineno-25-112">112</a></span>
<span class="normal"><a href="#__codelineno-25-113">113</a></span>
<span class="normal"><a href="#__codelineno-25-114">114</a></span>
<span class="normal"><a href="#__codelineno-25-115">115</a></span>
<span class="normal"><a href="#__codelineno-25-116">116</a></span>
<span class="normal"><a href="#__codelineno-25-117">117</a></span>
<span class="normal"><a href="#__codelineno-25-118">118</a></span>
<span class="normal"><a href="#__codelineno-25-119">119</a></span>
<span class="normal"><a href="#__codelineno-25-120">120</a></span>
<span class="normal"><a href="#__codelineno-25-121">121</a></span>
<span class="normal"><a href="#__codelineno-25-122">122</a></span>
<span class="normal"><a href="#__codelineno-25-123">123</a></span>
<span class="normal"><a href="#__codelineno-25-124">124</a></span>
<span class="normal"><a href="#__codelineno-25-125">125</a></span>
<span class="normal"><a href="#__codelineno-25-126">126</a></span>
<span class="normal"><a href="#__codelineno-25-127">127</a></span>
<span class="normal"><a href="#__codelineno-25-128">128</a></span>
<span class="normal"><a href="#__codelineno-25-129">129</a></span>
<span class="normal"><a href="#__codelineno-25-130">130</a></span>
<span class="normal"><a href="#__codelineno-25-131">131</a></span>
<span class="normal"><a href="#__codelineno-25-132">132</a></span>
<span class="normal"><a href="#__codelineno-25-133">133</a></span>
<span class="normal"><a href="#__codelineno-25-134">134</a></span>
<span class="normal"><a href="#__codelineno-25-135">135</a></span>
<span class="normal"><a href="#__codelineno-25-136">136</a></span>
<span class="normal"><a href="#__codelineno-25-137">137</a></span>
<span class="normal"><a href="#__codelineno-25-138">138</a></span>
<span class="normal"><a href="#__codelineno-25-139">139</a></span>
<span class="normal"><a href="#__codelineno-25-140">140</a></span>
<span class="normal"><a href="#__codelineno-25-141">141</a></span>
<span class="normal"><a href="#__codelineno-25-142">142</a></span>
<span class="normal"><a href="#__codelineno-25-143">143</a></span>
<span class="normal"><a href="#__codelineno-25-144">144</a></span>
<span class="normal"><a href="#__codelineno-25-145">145</a></span>
<span class="normal"><a href="#__codelineno-25-146">146</a></span>
<span class="normal"><a href="#__codelineno-25-147">147</a></span>
<span class="normal"><a href="#__codelineno-25-148">148</a></span>
<span class="normal"><a href="#__codelineno-25-149">149</a></span>
<span class="normal"><a href="#__codelineno-25-150">150</a></span>
<span class="normal"><a href="#__codelineno-25-151">151</a></span>
<span class="normal"><a href="#__codelineno-25-152">152</a></span>
<span class="normal"><a href="#__codelineno-25-153">153</a></span>
<span class="normal"><a href="#__codelineno-25-154">154</a></span>
<span class="normal"><a href="#__codelineno-25-155">155</a></span>
<span class="normal"><a href="#__codelineno-25-156">156</a></span>
<span class="normal"><a href="#__codelineno-25-157">157</a></span>
<span class="normal"><a href="#__codelineno-25-158">158</a></span>
<span class="normal"><a href="#__codelineno-25-159">159</a></span>
<span class="normal"><a href="#__codelineno-25-160">160</a></span>
<span class="normal"><a href="#__codelineno-25-161">161</a></span>
<span class="normal"><a href="#__codelineno-25-162">162</a></span>
<span class="normal"><a href="#__codelineno-25-163">163</a></span>
<span class="normal"><a href="#__codelineno-25-164">164</a></span>
<span class="normal"><a href="#__codelineno-25-165">165</a></span>
<span class="normal"><a href="#__codelineno-25-166">166</a></span>
<span class="normal"><a href="#__codelineno-25-167">167</a></span>
<span class="normal"><a href="#__codelineno-25-168">168</a></span>
<span class="normal"><a href="#__codelineno-25-169">169</a></span>
<span class="normal"><a href="#__codelineno-25-170">170</a></span>
<span class="normal"><a href="#__codelineno-25-171">171</a></span>
<span class="normal"><a href="#__codelineno-25-172">172</a></span>
<span class="normal"><a href="#__codelineno-25-173">173</a></span>
<span class="normal"><a href="#__codelineno-25-174">174</a></span>
<span class="normal"><a href="#__codelineno-25-175">175</a></span>
<span class="normal"><a href="#__codelineno-25-176">176</a></span>
<span class="normal"><a href="#__codelineno-25-177">177</a></span>
<span class="normal"><a href="#__codelineno-25-178">178</a></span>
<span class="normal"><a href="#__codelineno-25-179">179</a></span>
<span class="normal"><a href="#__codelineno-25-180">180</a></span>
<span class="normal"><a href="#__codelineno-25-181">181</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1">// author: (ttzytt)[ttzytt.com]</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctime&gt;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tuple&gt;</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">prio</span><span class="p">;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="w">  </span><span class="n">Node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">_val</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">val</span><span class="p">(</span><span class="n">_val</span><span class="p">),</span><span class="w"> </span><span class="n">cnt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="w">    </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a><span class="w">    </span><span class="n">prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a><span class="w">  </span><span class="n">Node</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">_node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">,</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">upd_siz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a><span class="w">    </span><span class="n">siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a><span class="p">};</span>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a><span class="k">struct</span><span class="w"> </span><span class="nc">none_rot_treap</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a><span class="cp">#define _3 second.second</span>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a><span class="cp">#define _2 second.first</span>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">root</span><span class="p">;</span>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a><span class="w">  </span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-38" name="__codelineno-25-38"></a><span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-25-40" name="__codelineno-25-40"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-41" name="__codelineno-25-41"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">};</span>
<a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-43" name="__codelineno-25-43"></a><span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-25-44" name="__codelineno-25-44"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-25-45" name="__codelineno-25-45"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-46" name="__codelineno-25-46"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">};</span>
<a id="__codelineno-25-47" name="__codelineno-25-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-48" name="__codelineno-25-48"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-49" name="__codelineno-25-49"></a>
<a id="__codelineno-25-50" name="__codelineno-25-50"></a><span class="w">  </span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-51" name="__codelineno-25-51"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<a id="__codelineno-25-52" name="__codelineno-25-52"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ls_siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-25-53" name="__codelineno-25-53"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ls_siz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-54" name="__codelineno-25-54"></a><span class="w">      </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-25-55" name="__codelineno-25-55"></a><span class="w">      </span><span class="n">tie</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">rk</span><span class="p">);</span>
<a id="__codelineno-25-56" name="__codelineno-25-56"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-25-57" name="__codelineno-25-57"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-58" name="__codelineno-25-58"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">};</span>
<a id="__codelineno-25-59" name="__codelineno-25-59"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ls_siz</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-60" name="__codelineno-25-60"></a><span class="w">      </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">lt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<a id="__codelineno-25-61" name="__codelineno-25-61"></a><span class="w">      </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-25-62" name="__codelineno-25-62"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-25-63" name="__codelineno-25-63"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">lt</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">rt</span><span class="p">};</span>
<a id="__codelineno-25-64" name="__codelineno-25-64"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-65" name="__codelineno-25-65"></a><span class="w">      </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-25-66" name="__codelineno-25-66"></a><span class="w">      </span><span class="n">tie</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">rk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ls_siz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">);</span>
<a id="__codelineno-25-67" name="__codelineno-25-67"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l</span><span class="p">;</span>
<a id="__codelineno-25-68" name="__codelineno-25-68"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-69" name="__codelineno-25-69"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">};</span>
<a id="__codelineno-25-70" name="__codelineno-25-70"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-71" name="__codelineno-25-71"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-72" name="__codelineno-25-72"></a>
<a id="__codelineno-25-73" name="__codelineno-25-73"></a><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">merge</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-74" name="__codelineno-25-74"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-25-75" name="__codelineno-25-75"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="__codelineno-25-76" name="__codelineno-25-76"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<a id="__codelineno-25-77" name="__codelineno-25-77"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-78" name="__codelineno-25-78"></a><span class="w">      </span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">v</span><span class="p">);</span>
<a id="__codelineno-25-79" name="__codelineno-25-79"></a><span class="w">      </span><span class="n">u</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-80" name="__codelineno-25-80"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">u</span><span class="p">;</span>
<a id="__codelineno-25-81" name="__codelineno-25-81"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-82" name="__codelineno-25-82"></a><span class="w">      </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-25-83" name="__codelineno-25-83"></a><span class="w">      </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-84" name="__codelineno-25-84"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<a id="__codelineno-25-85" name="__codelineno-25-85"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-86" name="__codelineno-25-86"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-87" name="__codelineno-25-87"></a>
<a id="__codelineno-25-88" name="__codelineno-25-88"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-89" name="__codelineno-25-89"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-25-90" name="__codelineno-25-90"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">l_tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-91" name="__codelineno-25-91"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">new_node</span><span class="p">;</span>
<a id="__codelineno-25-92" name="__codelineno-25-92"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-93" name="__codelineno-25-93"></a><span class="w">      </span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-25-94" name="__codelineno-25-94"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-95" name="__codelineno-25-95"></a><span class="w">      </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-25-96" name="__codelineno-25-96"></a><span class="w">      </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-97" name="__codelineno-25-97"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-98" name="__codelineno-25-98"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l_tr_combined</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-25-99" name="__codelineno-25-99"></a><span class="w">        </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">new_node</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-100" name="__codelineno-25-100"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr_combined</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-101" name="__codelineno-25-101"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-102" name="__codelineno-25-102"></a>
<a id="__codelineno-25-103" name="__codelineno-25-103"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">del</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-104" name="__codelineno-25-104"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-25-105" name="__codelineno-25-105"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">l_tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-106" name="__codelineno-25-106"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-107" name="__codelineno-25-107"></a><span class="w">      </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-25-108" name="__codelineno-25-108"></a><span class="w">      </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-25-109" name="__codelineno-25-109"></a><span class="w">      </span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-110" name="__codelineno-25-110"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-111" name="__codelineno-25-111"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-112" name="__codelineno-25-112"></a><span class="w">        </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-25-113" name="__codelineno-25-113"></a><span class="w">      </span><span class="p">}</span>
<a id="__codelineno-25-114" name="__codelineno-25-114"></a><span class="w">      </span><span class="k">delete</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-25-115" name="__codelineno-25-115"></a><span class="w">      </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-25-116" name="__codelineno-25-116"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-117" name="__codelineno-25-117"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-118" name="__codelineno-25-118"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-119" name="__codelineno-25-119"></a>
<a id="__codelineno-25-120" name="__codelineno-25-120"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">qrank_by_val</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-121" name="__codelineno-25-121"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-122" name="__codelineno-25-122"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-25-123" name="__codelineno-25-123"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-124" name="__codelineno-25-124"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-25-125" name="__codelineno-25-125"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-126" name="__codelineno-25-126"></a>
<a id="__codelineno-25-127" name="__codelineno-25-127"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">qval_by_rank</span><span class="p">(</span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-128" name="__codelineno-25-128"></a><span class="w">    </span><span class="n">Node</span><span class="w"> </span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-25-129" name="__codelineno-25-129"></a><span class="w">    </span><span class="n">tie</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split_by_rk</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">rk</span><span class="p">);</span>
<a id="__codelineno-25-130" name="__codelineno-25-130"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mid</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
<a id="__codelineno-25-131" name="__codelineno-25-131"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">),</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
<a id="__codelineno-25-132" name="__codelineno-25-132"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-25-133" name="__codelineno-25-133"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-134" name="__codelineno-25-134"></a>
<a id="__codelineno-25-135" name="__codelineno-25-135"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">qprev</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-136" name="__codelineno-25-136"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-137" name="__codelineno-25-137"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qval_by_rank</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">);</span>
<a id="__codelineno-25-138" name="__codelineno-25-138"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-139" name="__codelineno-25-139"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-25-140" name="__codelineno-25-140"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-141" name="__codelineno-25-141"></a>
<a id="__codelineno-25-142" name="__codelineno-25-142"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">qnex</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-143" name="__codelineno-25-143"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-25-144" name="__codelineno-25-144"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qval_by_rank</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-25-145" name="__codelineno-25-145"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-25-146" name="__codelineno-25-146"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-25-147" name="__codelineno-25-147"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-148" name="__codelineno-25-148"></a><span class="p">};</span>
<a id="__codelineno-25-149" name="__codelineno-25-149"></a>
<a id="__codelineno-25-150" name="__codelineno-25-150"></a><span class="n">none_rot_treap</span><span class="w"> </span><span class="n">tr</span><span class="p">;</span>
<a id="__codelineno-25-151" name="__codelineno-25-151"></a>
<a id="__codelineno-25-152" name="__codelineno-25-152"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-153" name="__codelineno-25-153"></a><span class="w">  </span><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="k">nullptr</span><span class="p">));</span>
<a id="__codelineno-25-154" name="__codelineno-25-154"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<a id="__codelineno-25-155" name="__codelineno-25-155"></a><span class="w">  </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<a id="__codelineno-25-156" name="__codelineno-25-156"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-157" name="__codelineno-25-157"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<a id="__codelineno-25-158" name="__codelineno-25-158"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num</span><span class="p">;</span>
<a id="__codelineno-25-159" name="__codelineno-25-159"></a><span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
<a id="__codelineno-25-160" name="__codelineno-25-160"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-161" name="__codelineno-25-161"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-25-162" name="__codelineno-25-162"></a><span class="w">        </span><span class="n">tr</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<a id="__codelineno-25-163" name="__codelineno-25-163"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-25-164" name="__codelineno-25-164"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-25-165" name="__codelineno-25-165"></a><span class="w">        </span><span class="n">tr</span><span class="p">.</span><span class="n">del</span><span class="p">(</span><span class="n">num</span><span class="p">);</span>
<a id="__codelineno-25-166" name="__codelineno-25-166"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-25-167" name="__codelineno-25-167"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-25-168" name="__codelineno-25-168"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">qrank_by_val</span><span class="p">(</span><span class="n">tr</span><span class="p">.</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-25-169" name="__codelineno-25-169"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-25-170" name="__codelineno-25-170"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<a id="__codelineno-25-171" name="__codelineno-25-171"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">qval_by_rank</span><span class="p">(</span><span class="n">tr</span><span class="p">.</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-25-172" name="__codelineno-25-172"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-25-173" name="__codelineno-25-173"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<a id="__codelineno-25-174" name="__codelineno-25-174"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">qprev</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-25-175" name="__codelineno-25-175"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-25-176" name="__codelineno-25-176"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span>
<a id="__codelineno-25-177" name="__codelineno-25-177"></a><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">qnex</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
<a id="__codelineno-25-178" name="__codelineno-25-178"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-25-179" name="__codelineno-25-179"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-180" name="__codelineno-25-180"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-25-181" name="__codelineno-25-181"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<h3 id="treap_6">无旋 treap 的区间操作<a class="headerlink" href="#treap_6" title="Permanent link">&para;</a></h3>
<h4 id="_27">指针实现<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<details class="note">
<summary>完整代码</summary>
<p>以下是前文讲解的代码的完整版本，是文艺平衡树题目的模板代码。</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C++</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">  1</a></span>
<span class="normal"><a href="#__codelineno-26-2">  2</a></span>
<span class="normal"><a href="#__codelineno-26-3">  3</a></span>
<span class="normal"><a href="#__codelineno-26-4">  4</a></span>
<span class="normal"><a href="#__codelineno-26-5">  5</a></span>
<span class="normal"><a href="#__codelineno-26-6">  6</a></span>
<span class="normal"><a href="#__codelineno-26-7">  7</a></span>
<span class="normal"><a href="#__codelineno-26-8">  8</a></span>
<span class="normal"><a href="#__codelineno-26-9">  9</a></span>
<span class="normal"><a href="#__codelineno-26-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-26-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-26-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-26-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-26-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-26-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-26-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-26-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-26-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-26-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-26-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-26-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-26-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-26-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-26-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-26-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-26-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-26-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-26-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-26-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-26-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-26-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-26-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-26-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-26-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-26-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-26-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-26-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-26-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-26-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-26-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-26-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-26-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-26-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-26-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-26-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-26-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-26-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-26-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-26-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-26-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-26-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-26-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-26-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-26-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-26-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-26-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-26-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-26-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-26-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-26-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-26-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-26-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-26-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-26-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-26-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-26-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-26-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-26-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-26-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-26-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-26-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-26-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-26-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-26-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-26-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-26-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-26-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-26-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-26-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-26-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-26-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-26-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-26-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-26-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-26-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-26-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-26-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-26-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-26-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-26-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-26-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-26-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-26-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-26-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-26-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-26-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-26-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-26-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-26-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-26-100">100</a></span>
<span class="normal"><a href="#__codelineno-26-101">101</a></span>
<span class="normal"><a href="#__codelineno-26-102">102</a></span>
<span class="normal"><a href="#__codelineno-26-103">103</a></span>
<span class="normal"><a href="#__codelineno-26-104">104</a></span>
<span class="normal"><a href="#__codelineno-26-105">105</a></span>
<span class="normal"><a href="#__codelineno-26-106">106</a></span>
<span class="normal"><a href="#__codelineno-26-107">107</a></span>
<span class="normal"><a href="#__codelineno-26-108">108</a></span>
<span class="normal"><a href="#__codelineno-26-109">109</a></span>
<span class="normal"><a href="#__codelineno-26-110">110</a></span>
<span class="normal"><a href="#__codelineno-26-111">111</a></span>
<span class="normal"><a href="#__codelineno-26-112">112</a></span>
<span class="normal"><a href="#__codelineno-26-113">113</a></span>
<span class="normal"><a href="#__codelineno-26-114">114</a></span>
<span class="normal"><a href="#__codelineno-26-115">115</a></span>
<span class="normal"><a href="#__codelineno-26-116">116</a></span>
<span class="normal"><a href="#__codelineno-26-117">117</a></span>
<span class="normal"><a href="#__codelineno-26-118">118</a></span>
<span class="normal"><a href="#__codelineno-26-119">119</a></span>
<span class="normal"><a href="#__codelineno-26-120">120</a></span>
<span class="normal"><a href="#__codelineno-26-121">121</a></span>
<span class="normal"><a href="#__codelineno-26-122">122</a></span>
<span class="normal"><a href="#__codelineno-26-123">123</a></span>
<span class="normal"><a href="#__codelineno-26-124">124</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="c1">// author: (ttzytt)[ttzytt.com]</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ctime&gt;</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="c1">// 参考：https://www.cnblogs.com/Equinox-Flower/p/10785292.html</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Node</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">  </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">prio</span><span class="p">;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">to_rev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">  </span><span class="c1">// 需要把这个子树下的每一个节点都翻转过来</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="w">  </span><span class="n">Node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">_val</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">val</span><span class="p">(</span><span class="n">_val</span><span class="p">),</span><span class="w"> </span><span class="n">cnt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="w">    </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="w">    </span><span class="n">prio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">upd_siz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">    </span><span class="n">siz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">siz</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">siz</span><span class="p">;</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">pushdown</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="w">    </span><span class="n">swap</span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">to_rev</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a><span class="w">    </span><span class="c1">// 如果原来子节点也要翻转，那两次翻转就抵消了，如果子节点不翻转，那这个</span>
<a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">    </span><span class="c1">//  tag 就需要继续被 push 到子节点上</span>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">to_rev</span><span class="w"> </span><span class="o">^=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-26-33" name="__codelineno-26-33"></a><span class="w">    </span><span class="n">to_rev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<a id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-35" name="__codelineno-26-35"></a>
<a id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">check_tag</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-37" name="__codelineno-26-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">to_rev</span><span class="p">)</span><span class="w"> </span><span class="n">pushdown</span><span class="p">();</span>
<a id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-39" name="__codelineno-26-39"></a><span class="p">};</span>
<a id="__codelineno-26-40" name="__codelineno-26-40"></a>
<a id="__codelineno-26-41" name="__codelineno-26-41"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Seg_treap</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-42" name="__codelineno-26-42"></a><span class="w">  </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">root</span><span class="p">;</span>
<a id="__codelineno-26-43" name="__codelineno-26-43"></a><span class="cp">#define siz(_) (_ == nullptr ? 0 : _-&gt;siz)</span>
<a id="__codelineno-26-44" name="__codelineno-26-44"></a>
<a id="__codelineno-26-45" name="__codelineno-26-45"></a><span class="w">  </span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">sz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-46" name="__codelineno-26-46"></a><span class="w">    </span><span class="c1">// 按照树的大小划分</span>
<a id="__codelineno-26-47" name="__codelineno-26-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">};</span>
<a id="__codelineno-26-48" name="__codelineno-26-48"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">();</span>
<a id="__codelineno-26-49" name="__codelineno-26-49"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sz</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-50" name="__codelineno-26-50"></a><span class="w">      </span><span class="c1">// 左边的子树就够了</span>
<a id="__codelineno-26-51" name="__codelineno-26-51"></a><span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">sz</span><span class="p">);</span>
<a id="__codelineno-26-52" name="__codelineno-26-52"></a><span class="w">      </span><span class="c1">// 左边的子树不一定全部需要，temp.second 是不需要的</span>
<a id="__codelineno-26-53" name="__codelineno-26-53"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
<a id="__codelineno-26-54" name="__codelineno-26-54"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-26-55" name="__codelineno-26-55"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">cur</span><span class="p">};</span>
<a id="__codelineno-26-56" name="__codelineno-26-56"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-57" name="__codelineno-26-57"></a><span class="w">      </span><span class="c1">// 左边的加上右边的一部分（当然也包括这个节点本身）</span>
<a id="__codelineno-26-58" name="__codelineno-26-58"></a><span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">sz</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">siz</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-59" name="__codelineno-26-59"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
<a id="__codelineno-26-60" name="__codelineno-26-60"></a><span class="w">      </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-26-61" name="__codelineno-26-61"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="n">cur</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">};</span>
<a id="__codelineno-26-62" name="__codelineno-26-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-63" name="__codelineno-26-63"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-64" name="__codelineno-26-64"></a>
<a id="__codelineno-26-65" name="__codelineno-26-65"></a><span class="w">  </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">sm</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">bg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-66" name="__codelineno-26-66"></a><span class="w">    </span><span class="c1">// small, big</span>
<a id="__codelineno-26-67" name="__codelineno-26-67"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-26-68" name="__codelineno-26-68"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">sm</span><span class="p">;</span>
<a id="__codelineno-26-69" name="__codelineno-26-69"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bg</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">bg</span><span class="p">;</span>
<a id="__codelineno-26-70" name="__codelineno-26-70"></a><span class="w">    </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">(),</span><span class="w"> </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">();</span>
<a id="__codelineno-26-71" name="__codelineno-26-71"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">prio</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-72" name="__codelineno-26-72"></a><span class="w">      </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">bg</span><span class="p">);</span>
<a id="__codelineno-26-73" name="__codelineno-26-73"></a><span class="w">      </span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-26-74" name="__codelineno-26-74"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">sm</span><span class="p">;</span>
<a id="__codelineno-26-75" name="__codelineno-26-75"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-76" name="__codelineno-26-76"></a><span class="w">      </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span><span class="w"> </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-26-77" name="__codelineno-26-77"></a><span class="w">      </span><span class="n">bg</span><span class="o">-&gt;</span><span class="n">upd_siz</span><span class="p">();</span>
<a id="__codelineno-26-78" name="__codelineno-26-78"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">bg</span><span class="p">;</span>
<a id="__codelineno-26-79" name="__codelineno-26-79"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-80" name="__codelineno-26-80"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-81" name="__codelineno-26-81"></a>
<a id="__codelineno-26-82" name="__codelineno-26-82"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-83" name="__codelineno-26-83"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-26-84" name="__codelineno-26-84"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">l_tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-85" name="__codelineno-26-85"></a><span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">new_node</span><span class="p">;</span>
<a id="__codelineno-26-86" name="__codelineno-26-86"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="n">new_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-26-87" name="__codelineno-26-87"></a><span class="w">    </span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">l_tr_combined</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-26-88" name="__codelineno-26-88"></a><span class="w">        </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">new_node</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">l_tr</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-26-89" name="__codelineno-26-89"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">l_tr_combined</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<a id="__codelineno-26-90" name="__codelineno-26-90"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-91" name="__codelineno-26-91"></a>
<a id="__codelineno-26-92" name="__codelineno-26-92"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">seg_rev</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-93" name="__codelineno-26-93"></a><span class="w">    </span><span class="c1">// 这里的 less 和 more 是相对于 l 的</span>
<a id="__codelineno-26-94" name="__codelineno-26-94"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">less</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-95" name="__codelineno-26-95"></a><span class="w">    </span><span class="c1">// 所有小于等于 l - 1 的会在 less 的左边</span>
<a id="__codelineno-26-96" name="__codelineno-26-96"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">less</span><span class="p">.</span><span class="n">second</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-26-97" name="__codelineno-26-97"></a><span class="w">    </span><span class="c1">// 拿出从 l 开始的前 r - l + 1 个</span>
<a id="__codelineno-26-98" name="__codelineno-26-98"></a><span class="w">    </span><span class="n">more</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">to_rev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-26-99" name="__codelineno-26-99"></a><span class="w">    </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">less</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">merge</span><span class="p">(</span><span class="n">more</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">more</span><span class="p">.</span><span class="n">second</span><span class="p">));</span>
<a id="__codelineno-26-100" name="__codelineno-26-100"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-101" name="__codelineno-26-101"></a>
<a id="__codelineno-26-102" name="__codelineno-26-102"></a><span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">print</span><span class="p">(</span><span class="n">Node</span><span class="o">*</span><span class="w"> </span><span class="n">cur</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-103" name="__codelineno-26-103"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cur</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">nullptr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-26-104" name="__codelineno-26-104"></a><span class="w">    </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">check_tag</span><span class="p">();</span>
<a id="__codelineno-26-105" name="__codelineno-26-105"></a><span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-26-106" name="__codelineno-26-106"></a><span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">;</span>
<a id="__codelineno-26-107" name="__codelineno-26-107"></a><span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-26-108" name="__codelineno-26-108"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-109" name="__codelineno-26-109"></a><span class="p">};</span>
<a id="__codelineno-26-110" name="__codelineno-26-110"></a>
<a id="__codelineno-26-111" name="__codelineno-26-111"></a><span class="n">Seg_treap</span><span class="w"> </span><span class="n">tr</span><span class="p">;</span>
<a id="__codelineno-26-112" name="__codelineno-26-112"></a>
<a id="__codelineno-26-113" name="__codelineno-26-113"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-114" name="__codelineno-26-114"></a><span class="w">  </span><span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="k">nullptr</span><span class="p">));</span>
<a id="__codelineno-26-115" name="__codelineno-26-115"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-26-116" name="__codelineno-26-116"></a><span class="w">  </span><span class="n">cin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
<a id="__codelineno-26-117" name="__codelineno-26-117"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">tr</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<a id="__codelineno-26-118" name="__codelineno-26-118"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-119" name="__codelineno-26-119"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-26-120" name="__codelineno-26-120"></a><span class="w">    </span><span class="n">cin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<a id="__codelineno-26-121" name="__codelineno-26-121"></a><span class="w">    </span><span class="n">tr</span><span class="p">.</span><span class="n">seg_rev</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">);</span>
<a id="__codelineno-26-122" name="__codelineno-26-122"></a><span class="w">  </span><span class="p">}</span>
<a id="__codelineno-26-123" name="__codelineno-26-123"></a><span class="w">  </span><span class="n">tr</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">tr</span><span class="p">.</span><span class="n">root</span><span class="p">);</span>
<a id="__codelineno-26-124" name="__codelineno-26-124"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="_28">例题<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h2>
<p><a href="https://loj.ac/problem/104">普通平衡树</a></p>
<p><a href="https://loj.ac/problem/105">文艺平衡树（Splay）</a></p>
<p><a href="https://www.luogu.com.cn/problem/P2596">「ZJOI2006」书架</a></p>
<p><a href="https://www.luogu.com.cn/problem/P2042">「NOI2005」维护数列</a></p>
<p><a href="http://codeforces.com/problemset/problem/702/F">CF 702F T-Shirts</a></p>
<h2 id="_29">参考资料与注释<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h2>
<div class="footnote">
<hr />
<ol>
<li id="fn:ref1">
<p>本图的设计参考了 <a href="https://en.wikipedia.org/wiki/Treap">维基百科 treap 词条的配图</a>&#160;<a class="footnote-backref" href="#fnref:ref1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:ref2">
<p><a href="https://charleswu.site/archives/1051">https://charleswu.site/archives/1051</a>&#160;<a class="footnote-backref" href="#fnref:ref2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:ref3">
<p><a href="https://www.cnblogs.com/Equinox-Flower/p/10785292.html">https://www.cnblogs.com/Equinox-Flower/p/10785292.html</a>&#160;<a class="footnote-backref" href="#fnref:ref3" title="Jump back to footnote 3 in the text">&#8617;</a><a class="footnote-backref" href="#fnref2:ref3" title="Jump back to footnote 3 in the text">&#8617;</a><a class="footnote-backref" href="#fnref3:ref3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:ref4">
<p><a href="https://www.luogu.com.cn/blog/85514/fhq-treap-xue-xi-bi-ji">https://www.luogu.com.cn/blog/85514/fhq-treap-xue-xi-bi-ji</a>&#160;<a class="footnote-backref" href="#fnref:ref4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>
<!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Render date of last update -->


<!-- Render date of creation -->


<!-- ---------------------------------------------------------------------- -->

<!-- Render authors -->


<!-- ---------------------------------------------------------------------- -->

<!-- Render committers from GitHub -->


<!-- Render committers from GitLab -->


<!-- Render committers -->


<!-- ---------------------------------------------------------------------- -->

<!-- Determine date of last update -->

  

  <!-- Determine date of creation -->
  


<!-- Source file information -->

<!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Determine feedback configuration -->

  


<!-- Determine whether to show feedback -->


<!-- Was this page helpful? -->

  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        此页面有帮助吗？
      </legend>
      <div class="md-feedback__inner">

        <!-- Feedback ratings -->
        <div class="md-feedback__list">
          
            <button
              class="md-feedback__icon md-icon"
              type="submit"
              title="This page was helpful"
              data-md-value="1"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg>
            </button>
          
            <button
              class="md-feedback__icon md-icon"
              type="submit"
              title="This page could be improved"
              data-md-value="0"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg>
            </button>
          
        </div>

        <!-- Feedback rating notes (shown after submission) -->
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              

              <!-- Determine title -->
              
                
              

              <!-- Replace {url} and {title} placeholders in note -->
              谢谢你的反馈！
            </div>
          
            <div data-md-value="0" hidden>
              

              <!-- Determine title -->
              
                
              

              <!-- Replace {url} and {title} placeholders in note -->
              Thanks for your feedback! Help us improve this page by using our <a href="https://marketingplatform.google.com/about/analytics/" target="_blank" rel="noopener">feedback form</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>

<!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Comment system -->





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <style>
  .md-footer {
      background-color: #f0f0f0;
  }
</style>


<!-- Footer -->
<footer class="md-footer">

  <!-- Link to previous and/or next page -->
  
    
  

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; gzh
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
   
      <font color="#B9B9B9">
      <div class="footer-visit-count" style="display: flex; justify-content: center; align-items: center;color: #000;">
        本站访问量：<script async src="//finicounter.eu.org/finicounter.js"></script>
        <span id="finicount_views"></span>    &nbsp;|&nbsp;
        <footer>
          <a href="https://icp.gov.moe/?keyword=20230640" target="_blank">萌ICP备20230640号</a>
        </footer>
      </div>
      </font>

        <style>
          .footer-visit-count {
              height: fit-content;
              min-height: 55px; /* 根据实际情况调整此高度 */
              color: #000;
          }
          </style>
        
          <div class="md-social">
  
    
    
    
    
    <a href="https://cdn.jsdelivr.net/gh/Gongzihang6/Pictures@main/Medias/%E6%88%91%E7%9A%84%E5%BE%AE%E4%BF%A1%E4%BA%8C%E7%BB%B4%E7%A0%81.png" target="_blank" rel="noopener" title="Wechat" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M385.2 167.6c6.4 0 12.6.3 18.8 1.1C387.4 90.3 303.3 32 207.7 32 100.5 32 13 104.8 13 197.4c0 53.4 29.3 97.5 77.9 131.6l-19.3 58.6 68-34.1c24.4 4.8 43.8 9.7 68.2 9.7 6.2 0 12.1-.3 18.3-.8-4-12.9-6.2-26.6-6.2-40.8-.1-84.9 72.9-154 165.3-154m-104.5-52.9c14.5 0 24.2 9.7 24.2 24.4 0 14.5-9.7 24.2-24.2 24.2-14.8 0-29.3-9.7-29.3-24.2.1-14.7 14.6-24.4 29.3-24.4m-136.4 48.6c-14.5 0-29.3-9.7-29.3-24.2 0-14.8 14.8-24.4 29.3-24.4 14.8 0 24.4 9.7 24.4 24.4 0 14.6-9.6 24.2-24.4 24.2M563 319.4c0-77.9-77.9-141.3-165.4-141.3-92.7 0-165.4 63.4-165.4 141.3S305 460.7 397.6 460.7c19.3 0 38.9-5.1 58.6-9.9l53.4 29.3-14.8-48.6C534 402.1 563 363.2 563 319.4m-219.1-24.5c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.8 0 24.4 9.7 24.4 19.3 0 10-9.7 19.6-24.4 19.6m107.1 0c-9.7 0-19.3-9.7-19.3-19.6 0-9.7 9.7-19.3 19.3-19.3 14.5 0 24.4 9.7 24.4 19.3.1 10-9.9 19.6-24.4 19.6"/></svg>
    </a>
  
    
    
    
    
    <a href="https://t.me/gongzihang" target="_blank" rel="noopener" title="telegram" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M248 8C111.033 8 0 119.033 0 256s111.033 248 248 248 248-111.033 248-248S384.967 8 248 8m114.952 168.66c-3.732 39.215-19.881 134.378-28.1 178.3-3.476 18.584-10.322 24.816-16.948 25.425-14.4 1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25 5.342-39.5 3.652-3.793 67.107-61.51 68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608 69.142-14.845 10.194-26.894 9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7 18.45-13.7 108.446-47.248 144.628-62.3c68.872-28.647 83.183-33.623 92.511-33.789 2.052-.034 6.639.474 9.61 2.885a10.45 10.45 0 0 1 3.53 6.716 43.8 43.8 0 0 1 .417 9.769"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/ZihangGong28792" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9zm-24.8 373.8h39.1L151.1 88h-42z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/Gongzihang6" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<zihanggong24@gmail.com>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M64 112c-8.8 0-16 7.2-16 16v22.1l172.5 141.6c20.7 17 50.4 17 71.1 0L464 150.1V128c0-8.8-7.2-16-16-16zM48 212.2V384c0 8.8 7.2 16 16 16h384c8.8 0 16-7.2 16-16V212.2L322 328.8c-38.4 31.5-93.7 31.5-132 0zM0 128c0-35.3 28.7-64 64-64h384c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://space.bilibili.com/688234000/lists" target="_blank" rel="noopener" title="space.bilibili.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M488.6 104.1c16.7 18.1 24.4 39.7 23.3 65.7v202.4c-.4 26.4-9.2 48.1-26.5 65.1-17.2 17-39.1 25.9-65.5 26.7H92.02c-26.45-.8-48.21-9.8-65.28-27.2C9.682 419.4.767 396.5 0 368.2V169.8c.767-26 9.682-47.6 26.74-65.7C43.81 87.75 65.57 78.77 92.02 78h29.38L96.05 52.19c-5.75-5.73-8.63-13-8.63-21.79 0-8.8 2.88-16.06 8.63-21.797C101.8 2.868 109.1 0 117.9 0q13.2 0 21.9 8.603L213.1 78h88l74.5-69.397C381.7 2.868 389.2 0 398 0q13.2 0 21.9 8.603c5.7 5.737 8.6 12.997 8.6 21.797 0 8.79-2.9 16.06-8.6 21.79L394.6 78h29.3c26.4.77 48 9.75 64.7 26.1m-38.8 69.7c-.4-9.6-3.7-17.4-10.7-23.5-5.2-6.1-14-9.4-22.7-9.8H96.05c-9.59.4-17.45 3.7-23.58 9.8-6.14 6.1-9.4 13.9-9.78 23.5v194.4c0 9.2 3.26 17 9.78 23.5s14.38 9.8 23.58 9.8H416.4c9.2 0 17-3.3 23.3-9.8s9.7-14.3 10.1-23.5zm-264.3 42.7c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.2 6.3-14 9.5-23.6 9.5s-17.5-3.2-23.6-9.5-9.4-14-9.8-23.2v-33.3c.4-9.1 3.8-16.9 10.1-23.2s13.2-9.6 23.3-10c9.2.4 17 3.7 23.3 10m191.5 0c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2s-14 9.5-23.6 9.5-17.4-3.2-23.6-9.5c-7-6.3-9.4-14-9.7-23.2v-33.3c.3-9.1 3.7-16.9 10-23.2s14.1-9.6 23.3-10c9.2.4 17 3.7 23.3 10"/></svg>
    </a>
  
</div>
        
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            


  


<h4>Cookie consent</h4>
<p>我们也使用cookies来识别您的重复访问和偏好来衡量我们文档的有效性以及用户是否找到他们要找的东西。 如果你同意,你可以帮助我们让我们的网站更好</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="analytics" checked>
      <span class="task-list-indicator"></span>
      Google Analytics
    </label>
  </li>

      
    
    
      
        
  
  
    
    
  
  <li class="task-list-item">
    <label class="task-list-control">
      <input type="checkbox" name="github" checked>
      <span class="task-list-indicator"></span>
      GitHub
    </label>
  </li>

      
    
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">同意</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">管理设定</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script>
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../../..", "features": ["announce.dismiss", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "search.share", "navigation.expand", "navigation.indexes", "content.tabs.link", "content.tooltips", "content.code.copy", "content.code.select", "content.code.annotate"], "search": "../../../../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../../../../../javascripts/extra.js"></script>
      
        <script src="../../../../../../javascripts/config_mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../../../../../javascripts/简历.js"></script>
      
    
  </body>
</html>